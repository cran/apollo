<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">

<head>

<meta charset="utf-8" />
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="pandoc" />

<meta name="viewport" content="width=device-width, initial-scale=1">

<meta name="author" content="David Palma" />

<meta name="date" content="2019-01-11" />

<title>Apollo examples</title>



<style type="text/css">code{white-space: pre;}</style>
<style type="text/css" data-origin="pandoc">
div.sourceCode { overflow-x: auto; }
table.sourceCode, tr.sourceCode, td.lineNumbers, td.sourceCode {
  margin: 0; padding: 0; vertical-align: baseline; border: none; }
table.sourceCode { width: 100%; line-height: 100%; }
td.lineNumbers { text-align: right; padding-right: 4px; padding-left: 4px; color: #aaaaaa; border-right: 1px solid #aaaaaa; }
td.sourceCode { padding-left: 5px; }
code > span.kw { color: #007020; font-weight: bold; } /* Keyword */
code > span.dt { color: #902000; } /* DataType */
code > span.dv { color: #40a070; } /* DecVal */
code > span.bn { color: #40a070; } /* BaseN */
code > span.fl { color: #40a070; } /* Float */
code > span.ch { color: #4070a0; } /* Char */
code > span.st { color: #4070a0; } /* String */
code > span.co { color: #60a0b0; font-style: italic; } /* Comment */
code > span.ot { color: #007020; } /* Other */
code > span.al { color: #ff0000; font-weight: bold; } /* Alert */
code > span.fu { color: #06287e; } /* Function */
code > span.er { color: #ff0000; font-weight: bold; } /* Error */
code > span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
code > span.cn { color: #880000; } /* Constant */
code > span.sc { color: #4070a0; } /* SpecialChar */
code > span.vs { color: #4070a0; } /* VerbatimString */
code > span.ss { color: #bb6688; } /* SpecialString */
code > span.im { } /* Import */
code > span.va { color: #19177c; } /* Variable */
code > span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code > span.op { color: #666666; } /* Operator */
code > span.bu { } /* BuiltIn */
code > span.ex { } /* Extension */
code > span.pp { color: #bc7a00; } /* Preprocessor */
code > span.at { color: #7d9029; } /* Attribute */
code > span.do { color: #ba2121; font-style: italic; } /* Documentation */
code > span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code > span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code > span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */

</style>
<script>
// apply pandoc div.sourceCode style to pre.sourceCode instead
(function() {
  var sheets = document.styleSheets;
  for (var i = 0; i < sheets.length; i++) {
    if (sheets[i].ownerNode.dataset["origin"] !== "pandoc") continue;
    try { var rules = sheets[i].cssRules; } catch (e) { continue; }
    for (var j = 0; j < rules.length; j++) {
      var rule = rules[j];
      // check if there is a div.sourceCode rule
      if (rule.type !== rule.STYLE_RULE || rule.selectorText !== "div.sourceCode") continue;
      var style = rule.style.cssText;
      // check if color or background-color is set
      if (rule.style.color === '' || rule.style.backgroundColor === '') continue;
      // replace div.sourceCode by a pre.sourceCode rule
      sheets[i].deleteRule(j);
      sheets[i].insertRule('pre.sourceCode{' + style + '}', j);
    }
  }
})();
</script>



<link href="data:text/css;charset=utf-8,body%20%7B%0Abackground%2Dcolor%3A%20%23fff%3B%0Amargin%3A%201em%20auto%3B%0Amax%2Dwidth%3A%20700px%3B%0Aoverflow%3A%20visible%3B%0Apadding%2Dleft%3A%202em%3B%0Apadding%2Dright%3A%202em%3B%0Afont%2Dfamily%3A%20%22Open%20Sans%22%2C%20%22Helvetica%20Neue%22%2C%20Helvetica%2C%20Arial%2C%20sans%2Dserif%3B%0Afont%2Dsize%3A%2014px%3B%0Aline%2Dheight%3A%201%2E35%3B%0A%7D%0A%23header%20%7B%0Atext%2Dalign%3A%20center%3B%0A%7D%0A%23TOC%20%7B%0Aclear%3A%20both%3B%0Amargin%3A%200%200%2010px%2010px%3B%0Apadding%3A%204px%3B%0Awidth%3A%20400px%3B%0Aborder%3A%201px%20solid%20%23CCCCCC%3B%0Aborder%2Dradius%3A%205px%3B%0Abackground%2Dcolor%3A%20%23f6f6f6%3B%0Afont%2Dsize%3A%2013px%3B%0Aline%2Dheight%3A%201%2E3%3B%0A%7D%0A%23TOC%20%2Etoctitle%20%7B%0Afont%2Dweight%3A%20bold%3B%0Afont%2Dsize%3A%2015px%3B%0Amargin%2Dleft%3A%205px%3B%0A%7D%0A%23TOC%20ul%20%7B%0Apadding%2Dleft%3A%2040px%3B%0Amargin%2Dleft%3A%20%2D1%2E5em%3B%0Amargin%2Dtop%3A%205px%3B%0Amargin%2Dbottom%3A%205px%3B%0A%7D%0A%23TOC%20ul%20ul%20%7B%0Amargin%2Dleft%3A%20%2D2em%3B%0A%7D%0A%23TOC%20li%20%7B%0Aline%2Dheight%3A%2016px%3B%0A%7D%0Atable%20%7B%0Amargin%3A%201em%20auto%3B%0Aborder%2Dwidth%3A%201px%3B%0Aborder%2Dcolor%3A%20%23DDDDDD%3B%0Aborder%2Dstyle%3A%20outset%3B%0Aborder%2Dcollapse%3A%20collapse%3B%0A%7D%0Atable%20th%20%7B%0Aborder%2Dwidth%3A%202px%3B%0Apadding%3A%205px%3B%0Aborder%2Dstyle%3A%20inset%3B%0A%7D%0Atable%20td%20%7B%0Aborder%2Dwidth%3A%201px%3B%0Aborder%2Dstyle%3A%20inset%3B%0Aline%2Dheight%3A%2018px%3B%0Apadding%3A%205px%205px%3B%0A%7D%0Atable%2C%20table%20th%2C%20table%20td%20%7B%0Aborder%2Dleft%2Dstyle%3A%20none%3B%0Aborder%2Dright%2Dstyle%3A%20none%3B%0A%7D%0Atable%20thead%2C%20table%20tr%2Eeven%20%7B%0Abackground%2Dcolor%3A%20%23f7f7f7%3B%0A%7D%0Ap%20%7B%0Amargin%3A%200%2E5em%200%3B%0A%7D%0Ablockquote%20%7B%0Abackground%2Dcolor%3A%20%23f6f6f6%3B%0Apadding%3A%200%2E25em%200%2E75em%3B%0A%7D%0Ahr%20%7B%0Aborder%2Dstyle%3A%20solid%3B%0Aborder%3A%20none%3B%0Aborder%2Dtop%3A%201px%20solid%20%23777%3B%0Amargin%3A%2028px%200%3B%0A%7D%0Adl%20%7B%0Amargin%2Dleft%3A%200%3B%0A%7D%0Adl%20dd%20%7B%0Amargin%2Dbottom%3A%2013px%3B%0Amargin%2Dleft%3A%2013px%3B%0A%7D%0Adl%20dt%20%7B%0Afont%2Dweight%3A%20bold%3B%0A%7D%0Aul%20%7B%0Amargin%2Dtop%3A%200%3B%0A%7D%0Aul%20li%20%7B%0Alist%2Dstyle%3A%20circle%20outside%3B%0A%7D%0Aul%20ul%20%7B%0Amargin%2Dbottom%3A%200%3B%0A%7D%0Apre%2C%20code%20%7B%0Abackground%2Dcolor%3A%20%23f7f7f7%3B%0Aborder%2Dradius%3A%203px%3B%0Acolor%3A%20%23333%3B%0Awhite%2Dspace%3A%20pre%2Dwrap%3B%20%0A%7D%0Apre%20%7B%0Aborder%2Dradius%3A%203px%3B%0Amargin%3A%205px%200px%2010px%200px%3B%0Apadding%3A%2010px%3B%0A%7D%0Apre%3Anot%28%5Bclass%5D%29%20%7B%0Abackground%2Dcolor%3A%20%23f7f7f7%3B%0A%7D%0Acode%20%7B%0Afont%2Dfamily%3A%20Consolas%2C%20Monaco%2C%20%27Courier%20New%27%2C%20monospace%3B%0Afont%2Dsize%3A%2085%25%3B%0A%7D%0Ap%20%3E%20code%2C%20li%20%3E%20code%20%7B%0Apadding%3A%202px%200px%3B%0A%7D%0Adiv%2Efigure%20%7B%0Atext%2Dalign%3A%20center%3B%0A%7D%0Aimg%20%7B%0Abackground%2Dcolor%3A%20%23FFFFFF%3B%0Apadding%3A%202px%3B%0Aborder%3A%201px%20solid%20%23DDDDDD%3B%0Aborder%2Dradius%3A%203px%3B%0Aborder%3A%201px%20solid%20%23CCCCCC%3B%0Amargin%3A%200%205px%3B%0A%7D%0Ah1%20%7B%0Amargin%2Dtop%3A%200%3B%0Afont%2Dsize%3A%2035px%3B%0Aline%2Dheight%3A%2040px%3B%0A%7D%0Ah2%20%7B%0Aborder%2Dbottom%3A%204px%20solid%20%23f7f7f7%3B%0Apadding%2Dtop%3A%2010px%3B%0Apadding%2Dbottom%3A%202px%3B%0Afont%2Dsize%3A%20145%25%3B%0A%7D%0Ah3%20%7B%0Aborder%2Dbottom%3A%202px%20solid%20%23f7f7f7%3B%0Apadding%2Dtop%3A%2010px%3B%0Afont%2Dsize%3A%20120%25%3B%0A%7D%0Ah4%20%7B%0Aborder%2Dbottom%3A%201px%20solid%20%23f7f7f7%3B%0Amargin%2Dleft%3A%208px%3B%0Afont%2Dsize%3A%20105%25%3B%0A%7D%0Ah5%2C%20h6%20%7B%0Aborder%2Dbottom%3A%201px%20solid%20%23ccc%3B%0Afont%2Dsize%3A%20105%25%3B%0A%7D%0Aa%20%7B%0Acolor%3A%20%230033dd%3B%0Atext%2Ddecoration%3A%20none%3B%0A%7D%0Aa%3Ahover%20%7B%0Acolor%3A%20%236666ff%3B%20%7D%0Aa%3Avisited%20%7B%0Acolor%3A%20%23800080%3B%20%7D%0Aa%3Avisited%3Ahover%20%7B%0Acolor%3A%20%23BB00BB%3B%20%7D%0Aa%5Bhref%5E%3D%22http%3A%22%5D%20%7B%0Atext%2Ddecoration%3A%20underline%3B%20%7D%0Aa%5Bhref%5E%3D%22https%3A%22%5D%20%7B%0Atext%2Ddecoration%3A%20underline%3B%20%7D%0A%0Acode%20%3E%20span%2Ekw%20%7B%20color%3A%20%23555%3B%20font%2Dweight%3A%20bold%3B%20%7D%20%0Acode%20%3E%20span%2Edt%20%7B%20color%3A%20%23902000%3B%20%7D%20%0Acode%20%3E%20span%2Edv%20%7B%20color%3A%20%2340a070%3B%20%7D%20%0Acode%20%3E%20span%2Ebn%20%7B%20color%3A%20%23d14%3B%20%7D%20%0Acode%20%3E%20span%2Efl%20%7B%20color%3A%20%23d14%3B%20%7D%20%0Acode%20%3E%20span%2Ech%20%7B%20color%3A%20%23d14%3B%20%7D%20%0Acode%20%3E%20span%2Est%20%7B%20color%3A%20%23d14%3B%20%7D%20%0Acode%20%3E%20span%2Eco%20%7B%20color%3A%20%23888888%3B%20font%2Dstyle%3A%20italic%3B%20%7D%20%0Acode%20%3E%20span%2Eot%20%7B%20color%3A%20%23007020%3B%20%7D%20%0Acode%20%3E%20span%2Eal%20%7B%20color%3A%20%23ff0000%3B%20font%2Dweight%3A%20bold%3B%20%7D%20%0Acode%20%3E%20span%2Efu%20%7B%20color%3A%20%23900%3B%20font%2Dweight%3A%20bold%3B%20%7D%20%20code%20%3E%20span%2Eer%20%7B%20color%3A%20%23a61717%3B%20background%2Dcolor%3A%20%23e3d2d2%3B%20%7D%20%0A" rel="stylesheet" type="text/css" />

</head>

<body>




<h1 class="title toc-ignore">Apollo examples</h1>
<h4 class="author"><em>David Palma</em></h4>
<h4 class="date"><em>2019-01-11</em></h4>



<div id="code-structure" class="section level2">
<h2>Code structure</h2>
<p>We recommend creating a separate <em>model .R file</em> for each model the user wants to estimate. In this document, three model file examples are presented.</p>
</div>
<div id="simple-mnl-model-file-example" class="section level2">
<h2>Simple MNL model file example</h2>
<p>The following code estimates a simple MNL model. No random coefficients are considered.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">### Load libraries
<span class="kw">library</span>(apollo)

### Set core controls
apollo_control =<span class="st"> </span><span class="kw">list</span>(
  <span class="dt">modelName =</span><span class="st">&quot;MNL&quot;</span>, <span class="co"># Make sure to use a new name for every model</span>
  <span class="dt">indivID   =</span><span class="st">&quot;ID&quot;</span>,  <span class="co"># Name of column in the database with each individual's ID</span>
  <span class="dt">mixing    =</span> <span class="ot">FALSE</span>,<span class="co"># TRUE for models that include random parameters</span>
  <span class="dt">nCores    =</span> <span class="dv">1</span>     <span class="co"># Number of cores to use in estimation</span>
)

### Load data
<span class="kw">data</span>(apollo_modeChoiceData)

### Model parameters
apollo_beta =<span class="st"> </span><span class="kw">c</span>(<span class="dt">asc_1=</span><span class="dv">0</span>, <span class="dt">asc_2=</span><span class="dv">0</span>,
                <span class="dt">asc_3=</span><span class="dv">0</span>, <span class="dt">asc_4=</span><span class="dv">0</span>,
                <span class="dt">tt   =</span><span class="dv">0</span>, <span class="dt">tc   =</span><span class="dv">0</span>,
                <span class="dt">acc  =</span><span class="dv">0</span>)

### Name of parameters fixed to starting values.
apollo_beta_fixed =<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;asc_2&quot;</span>)

### Likelihood function (do not change the arguments)
### b contains the parameters, x contains the explanatory variables
apollo_probabilities=<span class="cf">function</span>(b, x, <span class="dt">functionality=</span><span class="st">&quot;estimate&quot;</span>){
  P &lt;-<span class="st"> </span><span class="kw">list</span>() ### Do not delete. Store probabilities here.

  ### Enumerate alternatives and availability, and select choice variable.
  alternatives =<span class="st"> </span><span class="kw">c</span>(<span class="dt">car=</span><span class="dv">1</span>, <span class="dt">bus=</span><span class="dv">2</span>, <span class="dt">air=</span><span class="dv">3</span>, <span class="dt">rail=</span><span class="dv">4</span>)
  avail        =<span class="st"> </span><span class="kw">list</span>(<span class="dt">car=</span>x<span class="op">$</span>av_car, <span class="dt">bus=</span>x<span class="op">$</span>av_bus, <span class="dt">air=</span>x<span class="op">$</span>av_air, <span class="dt">rail=</span>x<span class="op">$</span>av_rail)
  choiceVar    =<span class="st"> </span>x<span class="op">$</span>choice

  ### List of utilities
  V =<span class="st"> </span><span class="kw">list</span>()
  V[[<span class="st">'car'</span> ]] =<span class="st"> </span>b<span class="op">$</span>asc_<span class="dv">1</span> <span class="op">+</span><span class="st"> </span>b<span class="op">$</span>tt<span class="op">*</span>x<span class="op">$</span>time_car  <span class="op">+</span><span class="st"> </span>b<span class="op">$</span>tc<span class="op">*</span>x<span class="op">$</span>cost_car
  V[[<span class="st">'bus'</span> ]] =<span class="st"> </span>b<span class="op">$</span>asc_<span class="dv">2</span> <span class="op">+</span><span class="st"> </span>b<span class="op">$</span>tt<span class="op">*</span>x<span class="op">$</span>time_bus  <span class="op">+</span><span class="st"> </span>b<span class="op">$</span>tc<span class="op">*</span>x<span class="op">$</span>cost_bus  <span class="op">+</span><span class="st"> </span>b<span class="op">$</span>acc<span class="op">*</span>x<span class="op">$</span>access_bus
  V[[<span class="st">'air'</span> ]] =<span class="st"> </span>b<span class="op">$</span>asc_<span class="dv">3</span> <span class="op">+</span><span class="st"> </span>b<span class="op">$</span>tt<span class="op">*</span>x<span class="op">$</span>time_air  <span class="op">+</span><span class="st"> </span>b<span class="op">$</span>tc<span class="op">*</span>x<span class="op">$</span>cost_air  <span class="op">+</span><span class="st"> </span>b<span class="op">$</span>acc<span class="op">*</span>x<span class="op">$</span>access_air
  V[[<span class="st">'rail'</span>]] =<span class="st"> </span>b<span class="op">$</span>asc_<span class="dv">4</span> <span class="op">+</span><span class="st"> </span>b<span class="op">$</span>tt<span class="op">*</span>x<span class="op">$</span>time_rail <span class="op">+</span><span class="st"> </span>b<span class="op">$</span>tc<span class="op">*</span>x<span class="op">$</span>cost_rail <span class="op">+</span><span class="st"> </span>b<span class="op">$</span>acc<span class="op">*</span>x<span class="op">$</span>access_rail

  ### Compute choice probabilities using MNL model
  P[[<span class="st">'model'</span>]] =<span class="st"> </span><span class="kw">apollo_mnl</span>(alternatives, avail, choiceVar, V, functionality)

  <span class="kw">return</span>(P)
}

### Estimate model
model =<span class="st"> </span><span class="kw">apollo_estimate</span>(apollo_beta, apollo_beta_fixed, database,
                        apollo_probabilities, apollo_control)
<span class="co">#&gt; Model description missing, set to default of 'No model description given'</span>
<span class="co">#&gt; Missing setting for seed, set to default of 13</span>
<span class="co">#&gt; Missing setting for HB, set to default of FALSE</span>
<span class="co">#&gt; Missing setting for noValidation, set to default of FALSE</span>
<span class="co">#&gt; Missing setting for noDiagnostics, set to default of FALSE</span>
<span class="co">#&gt; Missing setting for panelData.</span>
<span class="co">#&gt; Several observations per individual detected based on the value of ID.</span>
<span class="co">#&gt;   Setting panelData set to TRUE.</span>
<span class="co">#&gt; All checks on apollo_control completed.</span>
<span class="co">#&gt; All checks on data completed.</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Testing probability function (apollo_probabilities)</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; All checks passed for MNL model component</span>
<span class="co">#&gt; Overview of choices for MNL model component:</span>
<span class="co">#&gt;                                         car     bus     air    rail</span>
<span class="co">#&gt; Times available                     6224.00 7216.00 6016.00 6992.00</span>
<span class="co">#&gt; Times chosen                        2278.00  484.00 1737.00 3501.00</span>
<span class="co">#&gt; Percentage of choice overall          28.48    6.05   21.71   43.76</span>
<span class="co">#&gt; Percentage of choice when available   36.60    6.71   28.87   50.07</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; </span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Starting main estimation</span>
<span class="co">#&gt; Initial function value: -9366.881 </span>
<span class="co">#&gt; Initial gradient value:</span>
<span class="co">#&gt;       asc_1       asc_3       asc_4          tt          tc         acc </span>
<span class="co">#&gt;     438.000     -47.000    1362.333 -336419.583    8729.583   -9149.167 </span>
<span class="co">#&gt; initial  value 9366.880608 </span>
<span class="co">#&gt; iter   2 value 9009.644916</span>
<span class="co">#&gt; iter   3 value 7836.603614</span>
<span class="co">#&gt; iter   4 value 7832.564953</span>
<span class="co">#&gt; iter   5 value 7663.850418</span>
<span class="co">#&gt; iter   6 value 7582.030287</span>
<span class="co">#&gt; iter   7 value 7513.497183</span>
<span class="co">#&gt; iter   8 value 6929.142700</span>
<span class="co">#&gt; iter   9 value 6904.716287</span>
<span class="co">#&gt; iter  10 value 6899.094569</span>
<span class="co">#&gt; iter  11 value 6898.870366</span>
<span class="co">#&gt; iter  12 value 6898.861202</span>
<span class="co">#&gt; iter  13 value 6898.860795</span>
<span class="co">#&gt; iter  13 value 6898.860784</span>
<span class="co">#&gt; iter  13 value 6898.860784</span>
<span class="co">#&gt; final  value 6898.860784 </span>
<span class="co">#&gt; converged</span>
<span class="co">#&gt;          [,1]</span>
<span class="co">#&gt; asc_1  1.9004</span>
<span class="co">#&gt; asc_3  1.8973</span>
<span class="co">#&gt; asc_4  1.6306</span>
<span class="co">#&gt; tt    -0.0097</span>
<span class="co">#&gt; tc    -0.0509</span>
<span class="co">#&gt; acc   -0.0165</span>
<span class="co">#&gt; Computing covariance matrix using numDeriv package.</span>
<span class="co">#&gt;  (this may take a while)</span>
<span class="co">#&gt; 0%....25%....50%....75%...100%</span>

### Show output in screen
<span class="kw">apollo_modeloutput</span>(model)
<span class="co">#&gt; Model run using CMC choice modelling code for R, version alpha </span>
<span class="co">#&gt; www.cmc.leeds.ac.uk</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Model name                       : MNL</span>
<span class="co">#&gt; Model description                : No model description given</span>
<span class="co">#&gt; Model run at                     : 2019-01-11 18:20:16</span>
<span class="co">#&gt; Estimation method                : bfgs</span>
<span class="co">#&gt; Model diagnosis                  : successful convergence </span>
<span class="co">#&gt; Number of decision makers        : 500</span>
<span class="co">#&gt; Number of observations           : 8000</span>
<span class="co">#&gt; Estimated parameters             : 5</span>
<span class="co">#&gt; Model with no mixing</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; LL(start)                        : -9366.881</span>
<span class="co">#&gt; LL(0)                            : -9366.881</span>
<span class="co">#&gt; LL(final)                        : -6898.861</span>
<span class="co">#&gt; Rho-square (0)                   :  0.2635 </span>
<span class="co">#&gt; Adj.Rho-square (0)               :  0.2629 </span>
<span class="co">#&gt; AIC                              :  13807.72 </span>
<span class="co">#&gt; BIC                              :  13842.66 </span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Time taken (hh:mm:ss)            :  00:00:5.99 </span>
<span class="co">#&gt; Iterations                       :  15 </span>
<span class="co">#&gt; Number of cores used             :  1 </span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Estimates:</span>
<span class="co">#&gt;       Estimate Std.err. t.ratio(0) Rob.std.err. Rob.t.ratio(0)</span>
<span class="co">#&gt; asc_1   1.9004   0.0668      28.43       0.0813          23.38</span>
<span class="co">#&gt; asc_2   0.0000       NA         NA           NA             NA</span>
<span class="co">#&gt; asc_3   1.8973   0.1676      11.32       0.1829          10.37</span>
<span class="co">#&gt; asc_4   1.6306   0.1154      14.13       0.1277          12.77</span>
<span class="co">#&gt; tt     -0.0097   0.0005     -19.64       0.0005         -19.08</span>
<span class="co">#&gt; tc     -0.0509   0.0013     -39.64       0.0015         -34.11</span>
<span class="co">#&gt; acc    -0.0165   0.0023      -7.26       0.0022          -7.39</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; The following parameters were fixed (they have no std.err.):</span>
<span class="co">#&gt; asc_2</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Overview of choices for MNL model component:</span>
<span class="co">#&gt;                                         car     bus     air    rail</span>
<span class="co">#&gt; Times available                     6224.00 7216.00 6016.00 6992.00</span>
<span class="co">#&gt; Times chosen                        2278.00  484.00 1737.00 3501.00</span>
<span class="co">#&gt; Percentage of choice overall          28.48    6.05   21.71   43.76</span>
<span class="co">#&gt; Percentage of choice when available   36.60    6.71   28.87   50.07</span></code></pre></div>
</div>
<div id="mixed-mnl-model-with-inter-and-intra-individual-randomness." class="section level2">
<h2>Mixed MNL model with inter and intra-individual randomness.</h2>
<p>The following code estimates a mixed MNL model with random coefficients. Variability is both across and within individuals. Only 10 draws of each kind are used in the example, but significantly more are recommended for estimation.</p>
<p>If you want to use only one kind of draws, then set the corresponding nDraws variable to zero, and adjust the apollo_randcoeff function appropriately.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">### Load libraries
<span class="kw">library</span>(apollo)

### Set core controls
apollo_control =<span class="st"> </span><span class="kw">list</span>(
  <span class="dt">modelName =</span><span class="st">&quot;MMNL&quot;</span>,<span class="co"># Make sure to use a new name for every model</span>
  <span class="dt">indivID   =</span><span class="st">&quot;ID&quot;</span>,  <span class="co"># Name of column in the database with each individual's ID</span>
  <span class="dt">mixing    =</span> <span class="ot">TRUE</span>, <span class="co"># TRUE for models that include random parameters</span>
  <span class="dt">nCores    =</span> <span class="dv">1</span>     <span class="co"># Number of cores to use in estimation</span>
)

### Load data
<span class="kw">data</span>(apollo_modeChoiceData)

### Model parameters
apollo_beta =<span class="st"> </span><span class="kw">c</span>(<span class="dt">asc_1=</span> <span class="fl">1.9004</span>, <span class="dt">asc_2=</span> <span class="fl">0.0000</span>,
                <span class="dt">asc_3=</span> <span class="fl">1.8973</span>, <span class="dt">asc_4=</span> <span class="fl">1.6306</span>,
                <span class="dt">mu_tt=</span><span class="op">-</span><span class="fl">0.0097</span>, <span class="dt">sB_tt=</span> <span class="fl">0.0000</span>,
                <span class="dt">sW_tt=</span> <span class="fl">0.0000</span>, <span class="dt">mu_tc=</span><span class="op">-</span><span class="fl">0.0509</span>,
                <span class="dt">sB_tc=</span> <span class="fl">0.0000</span>, <span class="dt">acc  =</span><span class="op">-</span><span class="fl">0.0165</span>)

### Name of parameters fixed to starting values.
apollo_beta_fixed =<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;asc_2&quot;</span>)

### Set draws parameters
apollo_draws =<span class="st"> </span><span class="kw">list</span>(
  <span class="dt">inter_drawsType=</span><span class="st">&quot;halton&quot;</span>, <span class="co"># type of inter-person draws (options are MLHS, halton or pmc)</span>
  <span class="dt">inter_nDraws=</span><span class="dv">10</span>,          <span class="co"># number of inter-person draws per person. Set to 0 if only using intra-person draws.</span>
  <span class="dt">inter_unifDraws=</span><span class="kw">c</span>(),      <span class="co"># names of uniform distributed inter-person draws</span>
  <span class="dt">inter_normDraws=</span><span class="kw">c</span>(<span class="st">&quot;tt_inter&quot;</span>, <span class="st">&quot;tc_inter&quot;</span>, <span class="st">&quot;tt_tc_inter&quot;</span>), <span class="co"># names of normaly distributed inter-person draws</span>

  <span class="dt">intra_drawsType=</span><span class="st">'halton'</span>, <span class="co"># type of intra-person draws (options are MLHS, halton or pmc)</span>
  <span class="dt">intra_nDraws=</span><span class="dv">10</span>,          <span class="co"># number of intra-person draws per person. Set to 0 if only using inter-person draws.</span>
  <span class="dt">intra_unifDraws=</span><span class="kw">c</span>(),      <span class="co"># names of uniform distributed intra-person draws</span>
  <span class="dt">intra_normDraws=</span><span class="kw">c</span>(<span class="st">&quot;tt_intra&quot;</span>) <span class="co"># names of normaly distributed intra-person draws</span>
)

### Random coeffs must be created inside this function
apollo_randcoeff =<span class="st"> </span><span class="cf">function</span>(theta,draws){
  randcoeff =<span class="st"> </span><span class="kw">list</span>()

  randcoeff[[<span class="st">&quot;tt&quot;</span>]] =<span class="st"> </span><span class="op">-</span><span class="kw">exp</span>(theta[[<span class="st">&quot;mu_tt&quot;</span>]] <span class="op">+</span><span class="st"> </span>theta[[<span class="st">&quot;sB_tt&quot;</span>]]<span class="op">*</span>draws[[<span class="st">&quot;tt_inter&quot;</span>]] <span class="op">+</span><span class="st"> </span>theta[[<span class="st">&quot;sW_tt&quot;</span>]]<span class="op">*</span>draws[[<span class="st">&quot;tt_intra&quot;</span>]])
  randcoeff[[<span class="st">&quot;tc&quot;</span>]] =<span class="st"> </span><span class="op">-</span><span class="kw">exp</span>(theta[[<span class="st">&quot;mu_tc&quot;</span>]] <span class="op">+</span><span class="st"> </span>theta[[<span class="st">&quot;sB_tc&quot;</span>]]<span class="op">*</span>draws[[<span class="st">&quot;tc_inter&quot;</span>]])

  <span class="kw">return</span>(randcoeff)
}

### Likelihood function (do not change the arguments)
### b contains the parameters, x contains the explanatory variables
apollo_probabilities=<span class="cf">function</span>(b, x, <span class="dt">functionality=</span><span class="st">&quot;estimate&quot;</span>){
  P &lt;-<span class="st"> </span><span class="kw">list</span>() ### Do not delete. Store probabilities here.

  ### Enumerate alternatives and availability, and select choice variable.
  alternatives =<span class="st"> </span><span class="kw">c</span>(<span class="dt">car=</span><span class="dv">1</span>, <span class="dt">bus=</span><span class="dv">2</span>, <span class="dt">air=</span><span class="dv">3</span>, <span class="dt">rail=</span><span class="dv">4</span>)
  avail        =<span class="st"> </span><span class="kw">list</span>(<span class="dt">car=</span>x<span class="op">$</span>av_car, <span class="dt">bus=</span>x<span class="op">$</span>av_bus, <span class="dt">air=</span>x<span class="op">$</span>av_air, <span class="dt">rail=</span>x<span class="op">$</span>av_rail)
  choiceVar    =<span class="st"> </span>x<span class="op">$</span>choice

  ### List of utilities
  V =<span class="st"> </span><span class="kw">list</span>()
  V[[<span class="st">'car'</span> ]] =<span class="st"> </span>b<span class="op">$</span>asc_<span class="dv">1</span> <span class="op">+</span><span class="st"> </span>b<span class="op">$</span>tt<span class="op">*</span>x<span class="op">$</span>time_car  <span class="op">+</span><span class="st"> </span>b<span class="op">$</span>tc<span class="op">*</span>x<span class="op">$</span>cost_car
  V[[<span class="st">'bus'</span> ]] =<span class="st"> </span>b<span class="op">$</span>asc_<span class="dv">2</span> <span class="op">+</span><span class="st"> </span>b<span class="op">$</span>tt<span class="op">*</span>x<span class="op">$</span>time_bus  <span class="op">+</span><span class="st"> </span>b<span class="op">$</span>tc<span class="op">*</span>x<span class="op">$</span>cost_bus  <span class="op">+</span><span class="st"> </span>b<span class="op">$</span>acc<span class="op">*</span>x<span class="op">$</span>access_bus
  V[[<span class="st">'air'</span> ]] =<span class="st"> </span>b<span class="op">$</span>asc_<span class="dv">3</span> <span class="op">+</span><span class="st"> </span>b<span class="op">$</span>tt<span class="op">*</span>x<span class="op">$</span>time_air  <span class="op">+</span><span class="st"> </span>b<span class="op">$</span>tc<span class="op">*</span>x<span class="op">$</span>cost_air  <span class="op">+</span><span class="st"> </span>b<span class="op">$</span>acc<span class="op">*</span>x<span class="op">$</span>access_air
  V[[<span class="st">'rail'</span>]] =<span class="st"> </span>b<span class="op">$</span>asc_<span class="dv">4</span> <span class="op">+</span><span class="st"> </span>b<span class="op">$</span>tt<span class="op">*</span>x<span class="op">$</span>time_rail <span class="op">+</span><span class="st"> </span>b<span class="op">$</span>tc<span class="op">*</span>x<span class="op">$</span>cost_rail <span class="op">+</span><span class="st"> </span>b<span class="op">$</span>acc<span class="op">*</span>x<span class="op">$</span>access_rail

  ### Compute choice probabilities using MNL model
  P[[<span class="st">'model'</span>]] =<span class="st"> </span><span class="kw">apollo_mnl</span>(alternatives, avail, choiceVar, V, functionality)

  <span class="kw">return</span>(P)
}

### Estimate model
model =<span class="st"> </span><span class="kw">apollo_estimate</span>(apollo_beta, apollo_beta_fixed, database,
                        apollo_probabilities, apollo_control,
                        apollo_draws, apollo_randcoeff, <span class="dt">work_in_logs=</span><span class="ot">TRUE</span>)

### Show output in screen
<span class="kw">apollo_modeloutput</span>(model)</code></pre></div>
</div>



<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
