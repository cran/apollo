<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />

<meta name="viewport" content="width=device-width, initial-scale=1" />

<meta name="author" content="David Palma, Stephane Hess" />

<meta name="date" content="2020-12-05" />

<title>Model file examples</title>

<script>// Hide empty <a> tag within highlighted CodeBlock for screen reader accessibility (see https://github.com/jgm/pandoc/issues/6352#issuecomment-626106786) -->
// v0.0.1
// Written by JooYoung Seo (jooyoung@psu.edu) and Atsushi Yasumoto on June 1st, 2020.

document.addEventListener('DOMContentLoaded', function() {
  const codeList = document.getElementsByClassName("sourceCode");
  for (var i = 0; i < codeList.length; i++) {
    var linkList = codeList[i].getElementsByTagName('a');
    for (var j = 0; j < linkList.length; j++) {
      if (linkList[j].innerHTML === "") {
        linkList[j].setAttribute('aria-hidden', 'true');
      }
    }
  }
});
</script>

<style type="text/css">
  code{white-space: pre-wrap;}
  span.smallcaps{font-variant: small-caps;}
  span.underline{text-decoration: underline;}
  div.column{display: inline-block; vertical-align: top; width: 50%;}
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  ul.task-list{list-style: none;}
      code.sourceCode > span { display: inline-block; line-height: 1.25; }
  code.sourceCode > span { color: inherit; text-decoration: inherit; }
  code.sourceCode > span:empty { height: 1.2em; }
  .sourceCode { overflow: visible; }
  code.sourceCode { white-space: pre; position: relative; }
  div.sourceCode { margin: 1em 0; }
  pre.sourceCode { margin: 0; }
  @media screen {
  div.sourceCode { overflow: auto; }
  }
  @media print {
  code.sourceCode { white-space: pre-wrap; }
  code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
  }
  pre.numberSource code
    { counter-reset: source-line 0; }
  pre.numberSource code > span
    { position: relative; left: -4em; counter-increment: source-line; }
  pre.numberSource code > span > a:first-child::before
    { content: counter(source-line);
      position: relative; left: -1em; text-align: right; vertical-align: baseline;
      border: none; display: inline-block;
      -webkit-touch-callout: none; -webkit-user-select: none;
      -khtml-user-select: none; -moz-user-select: none;
      -ms-user-select: none; user-select: none;
      padding: 0 4px; width: 4em;
      color: #aaaaaa;
    }
  pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
  div.sourceCode
    {   }
  @media screen {
  code.sourceCode > span > a:first-child::before { text-decoration: underline; }
  }
  code span.al { color: #ff0000; font-weight: bold; } /* Alert */
  code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
  code span.at { color: #7d9029; } /* Attribute */
  code span.bn { color: #40a070; } /* BaseN */
  code span.bu { } /* BuiltIn */
  code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
  code span.ch { color: #4070a0; } /* Char */
  code span.cn { color: #880000; } /* Constant */
  code span.co { color: #60a0b0; font-style: italic; } /* Comment */
  code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
  code span.do { color: #ba2121; font-style: italic; } /* Documentation */
  code span.dt { color: #902000; } /* DataType */
  code span.dv { color: #40a070; } /* DecVal */
  code span.er { color: #ff0000; font-weight: bold; } /* Error */
  code span.ex { } /* Extension */
  code span.fl { color: #40a070; } /* Float */
  code span.fu { color: #06287e; } /* Function */
  code span.im { } /* Import */
  code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
  code span.kw { color: #007020; font-weight: bold; } /* Keyword */
  code span.op { color: #666666; } /* Operator */
  code span.ot { color: #007020; } /* Other */
  code span.pp { color: #bc7a00; } /* Preprocessor */
  code span.sc { color: #4070a0; } /* SpecialChar */
  code span.ss { color: #bb6688; } /* SpecialString */
  code span.st { color: #4070a0; } /* String */
  code span.va { color: #19177c; } /* Variable */
  code span.vs { color: #4070a0; } /* VerbatimString */
  code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
    </style>


<style type="text/css">code{white-space: pre;}</style>
<style type="text/css" data-origin="pandoc">
code.sourceCode > span { display: inline-block; line-height: 1.25; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */

</style>
<script>
// apply pandoc div.sourceCode style to pre.sourceCode instead
(function() {
  var sheets = document.styleSheets;
  for (var i = 0; i < sheets.length; i++) {
    if (sheets[i].ownerNode.dataset["origin"] !== "pandoc") continue;
    try { var rules = sheets[i].cssRules; } catch (e) { continue; }
    for (var j = 0; j < rules.length; j++) {
      var rule = rules[j];
      // check if there is a div.sourceCode rule
      if (rule.type !== rule.STYLE_RULE || rule.selectorText !== "div.sourceCode") continue;
      var style = rule.style.cssText;
      // check if color or background-color is set
      if (rule.style.color === '' && rule.style.backgroundColor === '') continue;
      // replace div.sourceCode by a pre.sourceCode rule
      sheets[i].deleteRule(j);
      sheets[i].insertRule('pre.sourceCode{' + style + '}', j);
    }
  }
})();
</script>



<style type="text/css">body {
background-color: #fff;
margin: 1em auto;
max-width: 700px;
overflow: visible;
padding-left: 2em;
padding-right: 2em;
font-family: "Open Sans", "Helvetica Neue", Helvetica, Arial, sans-serif;
font-size: 14px;
line-height: 1.35;
}
#TOC {
clear: both;
margin: 0 0 10px 10px;
padding: 4px;
width: 400px;
border: 1px solid #CCCCCC;
border-radius: 5px;
background-color: #f6f6f6;
font-size: 13px;
line-height: 1.3;
}
#TOC .toctitle {
font-weight: bold;
font-size: 15px;
margin-left: 5px;
}
#TOC ul {
padding-left: 40px;
margin-left: -1.5em;
margin-top: 5px;
margin-bottom: 5px;
}
#TOC ul ul {
margin-left: -2em;
}
#TOC li {
line-height: 16px;
}
table {
margin: 1em auto;
border-width: 1px;
border-color: #DDDDDD;
border-style: outset;
border-collapse: collapse;
}
table th {
border-width: 2px;
padding: 5px;
border-style: inset;
}
table td {
border-width: 1px;
border-style: inset;
line-height: 18px;
padding: 5px 5px;
}
table, table th, table td {
border-left-style: none;
border-right-style: none;
}
table thead, table tr.even {
background-color: #f7f7f7;
}
p {
margin: 0.5em 0;
}
blockquote {
background-color: #f6f6f6;
padding: 0.25em 0.75em;
}
hr {
border-style: solid;
border: none;
border-top: 1px solid #777;
margin: 28px 0;
}
dl {
margin-left: 0;
}
dl dd {
margin-bottom: 13px;
margin-left: 13px;
}
dl dt {
font-weight: bold;
}
ul {
margin-top: 0;
}
ul li {
list-style: circle outside;
}
ul ul {
margin-bottom: 0;
}
pre, code {
background-color: #f7f7f7;
border-radius: 3px;
color: #333;
white-space: pre-wrap; 
}
pre {
border-radius: 3px;
margin: 5px 0px 10px 0px;
padding: 10px;
}
pre:not([class]) {
background-color: #f7f7f7;
}
code {
font-family: Consolas, Monaco, 'Courier New', monospace;
font-size: 85%;
}
p > code, li > code {
padding: 2px 0px;
}
div.figure {
text-align: center;
}
img {
background-color: #FFFFFF;
padding: 2px;
border: 1px solid #DDDDDD;
border-radius: 3px;
border: 1px solid #CCCCCC;
margin: 0 5px;
}
h1 {
margin-top: 0;
font-size: 35px;
line-height: 40px;
}
h2 {
border-bottom: 4px solid #f7f7f7;
padding-top: 10px;
padding-bottom: 2px;
font-size: 145%;
}
h3 {
border-bottom: 2px solid #f7f7f7;
padding-top: 10px;
font-size: 120%;
}
h4 {
border-bottom: 1px solid #f7f7f7;
margin-left: 8px;
font-size: 105%;
}
h5, h6 {
border-bottom: 1px solid #ccc;
font-size: 105%;
}
a {
color: #0033dd;
text-decoration: none;
}
a:hover {
color: #6666ff; }
a:visited {
color: #800080; }
a:visited:hover {
color: #BB00BB; }
a[href^="http:"] {
text-decoration: underline; }
a[href^="https:"] {
text-decoration: underline; }

code > span.kw { color: #555; font-weight: bold; } 
code > span.dt { color: #902000; } 
code > span.dv { color: #40a070; } 
code > span.bn { color: #d14; } 
code > span.fl { color: #d14; } 
code > span.ch { color: #d14; } 
code > span.st { color: #d14; } 
code > span.co { color: #888888; font-style: italic; } 
code > span.ot { color: #007020; } 
code > span.al { color: #ff0000; font-weight: bold; } 
code > span.fu { color: #900; font-weight: bold; } 
code > span.er { color: #a61717; background-color: #e3d2d2; } 
</style>




</head>

<body>




<h1 class="title toc-ignore">Model file examples</h1>
<h4 class="author">David Palma, Stephane Hess</h4>
<h4 class="date">2020-12-05</h4>



<div id="about-the-package" class="section level2">
<h2>About the package</h2>
<p><em>Apollo</em> is an R package designed for estimation and analysis of choice models (Train, 2008). This package allows estimating Multinomial logit (MNL), Nested logit (NL), cross-nested logit (CNL), exploded logit (EL), ordered logit (OL), Integrated Choice and Latent Variable (ICLV, Ben-Akiva et al. 2002), Multiple Discrete-Continuous Extreme Value (MDCEV, Bhat 2008), nested MDCEV (MDCNEV, Pinjari and Bhat 2010), and Decision Field Theory (DFT, Hancock and Hess 2018) models. All models support both continuous and discrete mixing (e.g. continuous random parameters, latent classes or finite mixtures), both between and within individuals (i.e at the individual and observation level). Different models can be easily combined for joint estimation. The package allows for classical estimation (i.e. maximum likelihood) as well as Bayesian estimation (i.e. hierarchical Bayes, through package RSGHB).</p>
<p>All functionalities are described in the manual, available at www.ApolloChoiceModelling.com. Examples can also be found on the website.</p>
</div>
<div id="recommended-workflow" class="section level2">
<h2>Recommended workflow</h2>
<p>The recommended way to use <em>Apollo</em> is to create a different R script for each model to estimate. These scripts are refer to as <em>model files</em> and contain all the necessary information to estimate the model (except for the data), and can also include post-estimation analysis of the results.</p>
<p>A model file should be structured around the following sections:</p>
<ol style="list-style-type: decimal">
<li><p><strong>Definition of core settings</strong>: In this section the <em>Apollo</em> library is loaded, and global variables such as the name of the model are defined.</p></li>
<li><p><strong>Data loading</strong>: In this section the database is loaded. Any transformation to the data that does not depend on parameters to be estimated (e.g. averages of explanatory variables) should be performed here and stored inside the database object.</p></li>
<li><p><strong>Parameter definition</strong>: In this section, a vector containing the names and starting values of parameters is defined, as well as details of their mixing distributions if present.</p></li>
<li><p><strong>Input validation</strong>: In this section, all inputs prepared in the previous sections are validated and stored together.</p></li>
<li><p><strong>Likelihood definition</strong>: In this section, the user must write a function that calculates the model likelihood.</p></li>
<li><p><strong>Model estimation and reporting</strong>: In this section, the model is estimated and the results are displayed.</p></li>
<li><p><strong>Postprocessing of results</strong>: This is an optional section where the user can do forecasting and other post-processing of the estrimated model.</p></li>
</ol>
<p>In this document, we present two example model files: a multinomial logit (MNL) model, and a mixed multinomial logit (MMNL) model. More examples, discussed in more detail are available at www.ApolloChoiceModelling.com.</p>
</div>
<div id="mnl-model-file-example" class="section level2">
<h2>MNL model file example</h2>
<p>In this section, we present code to estimate an MNL model using the synthetic data included in the package. In the postprocessing, we predict the impact on mode share of a 10% increase in the cost of the train fare. The utility functions of alternatives are defined as follows.</p>
<p><span class="math display">\[U_{nsi} = asc_i + \beta_{tt}tt_{nsi} + \beta_{c}*cost_{nsi} + \varepsilon_{nsi}\]</span></p>
<p>Where <em>n</em> indexes individuals, <em>s</em> choice scenarios, and <em>i</em> alternatives. <span class="math inline">\(asc_i\)</span> is the alternative specific constant, <span class="math inline">\(tt_{nsi}\)</span> is the travel time and <span class="math inline">\(cost_{nsi}\)</span> is the cost. <span class="math inline">\(\varepsilon_{nsi}\)</span> is an independent identically distributed standard Gumbel error term. <span class="math inline">\(asc_i\)</span>, <span class="math inline">\(\beta_{tt}\)</span> and <span class="math inline">\(\beta_{c}\)</span> are parameters to be estimated.</p>
<p>The likelihood function of this model for individual <span class="math inline">\(n\)</span> is as follows.</p>
<p><span class="math display">\[L_{n}=\prod_{s}P_{nsi}\]</span></p>
<p>Where <span class="math display">\[P_{nsi}=\frac{e^{V_{nsi}}}{\sum_{j}e^{V_{nsj}}}\]</span> And <span class="math inline">\(V_{nsi}=U_{nsi}-\varepsilon_{nsi}\)</span>, i.e. the deterministic part of the utility.</p>
<p>The likelihood function of the MNL model is pre-coded in <code>Apollo</code>, so we do not need to type it ourselves. However, if the user prefers to write the likelihood themselves, they can also do it. The pre-coded MNL likelihood function (<code>apollo_mnl</code>) requires a series of inputs defined inside the <code>mnl_settings</code> object.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1"></a><span class="co"># ####################################################### #</span></span>
<span id="cb1-2"><a href="#cb1-2"></a><span class="co">#### 1. Definition of core settings                        </span></span>
<span id="cb1-3"><a href="#cb1-3"></a><span class="co"># ####################################################### #</span></span>
<span id="cb1-4"><a href="#cb1-4"></a></span>
<span id="cb1-5"><a href="#cb1-5"></a><span class="co">### Clear memory</span></span>
<span id="cb1-6"><a href="#cb1-6"></a><span class="kw">rm</span>(<span class="dt">list =</span> <span class="kw">ls</span>())</span>
<span id="cb1-7"><a href="#cb1-7"></a></span>
<span id="cb1-8"><a href="#cb1-8"></a><span class="co">### Load libraries</span></span>
<span id="cb1-9"><a href="#cb1-9"></a><span class="kw">library</span>(apollo)</span>
<span id="cb1-10"><a href="#cb1-10"></a><span class="co">#&gt; Apollo 0.2.2</span></span>
<span id="cb1-11"><a href="#cb1-11"></a><span class="co">#&gt; www.ApolloChoiceModelling.com</span></span>
<span id="cb1-12"><a href="#cb1-12"></a><span class="co">#&gt; See url for a detailed manual, examples and a help forum.</span></span>
<span id="cb1-13"><a href="#cb1-13"></a><span class="co">#&gt; Sign up to our mailing list for updates on new releases.</span></span>
<span id="cb1-14"><a href="#cb1-14"></a></span>
<span id="cb1-15"><a href="#cb1-15"></a><span class="co">### Initialise code</span></span>
<span id="cb1-16"><a href="#cb1-16"></a><span class="kw">apollo_initialise</span>()</span>
<span id="cb1-17"><a href="#cb1-17"></a></span>
<span id="cb1-18"><a href="#cb1-18"></a><span class="co">### Set core controls</span></span>
<span id="cb1-19"><a href="#cb1-19"></a>apollo_control =<span class="st"> </span><span class="kw">list</span>(</span>
<span id="cb1-20"><a href="#cb1-20"></a>  <span class="dt">modelName  =</span><span class="st">&quot;MNL&quot;</span>,</span>
<span id="cb1-21"><a href="#cb1-21"></a>  <span class="dt">modelDescr =</span><span class="st">&quot;Simple MNL model on mode choice SP data&quot;</span>,</span>
<span id="cb1-22"><a href="#cb1-22"></a>  <span class="dt">indivID    =</span><span class="st">&quot;ID&quot;</span></span>
<span id="cb1-23"><a href="#cb1-23"></a>)</span>
<span id="cb1-24"><a href="#cb1-24"></a></span>
<span id="cb1-25"><a href="#cb1-25"></a><span class="co"># ####################################################### #</span></span>
<span id="cb1-26"><a href="#cb1-26"></a><span class="co">#### 2. Data loading                                   ####</span></span>
<span id="cb1-27"><a href="#cb1-27"></a><span class="co"># ####################################################### #</span></span>
<span id="cb1-28"><a href="#cb1-28"></a></span>
<span id="cb1-29"><a href="#cb1-29"></a><span class="kw">data</span>(<span class="st">&quot;apollo_modeChoiceData&quot;</span>, <span class="dt">package=</span><span class="st">&quot;apollo&quot;</span>)</span>
<span id="cb1-30"><a href="#cb1-30"></a>database =<span class="st"> </span>apollo_modeChoiceData</span>
<span id="cb1-31"><a href="#cb1-31"></a><span class="kw">rm</span>(apollo_modeChoiceData)</span>
<span id="cb1-32"><a href="#cb1-32"></a></span>
<span id="cb1-33"><a href="#cb1-33"></a><span class="co">### Use only SP data</span></span>
<span id="cb1-34"><a href="#cb1-34"></a>database =<span class="st"> </span><span class="kw">subset</span>(database,database<span class="op">$</span>SP<span class="op">==</span><span class="dv">1</span>)</span>
<span id="cb1-35"><a href="#cb1-35"></a></span>
<span id="cb1-36"><a href="#cb1-36"></a><span class="co"># ####################################################### #</span></span>
<span id="cb1-37"><a href="#cb1-37"></a><span class="co">#### 3. Parameter definition                           ####</span></span>
<span id="cb1-38"><a href="#cb1-38"></a><span class="co"># ####################################################### #</span></span>
<span id="cb1-39"><a href="#cb1-39"></a></span>
<span id="cb1-40"><a href="#cb1-40"></a><span class="co">### Vector of parameters, including any that are kept fixed </span></span>
<span id="cb1-41"><a href="#cb1-41"></a><span class="co">### during estimation</span></span>
<span id="cb1-42"><a href="#cb1-42"></a>apollo_beta=<span class="kw">c</span>(<span class="dt">asc_car  =</span> <span class="dv">0</span>,</span>
<span id="cb1-43"><a href="#cb1-43"></a>              <span class="dt">asc_bus  =</span> <span class="dv">0</span>,</span>
<span id="cb1-44"><a href="#cb1-44"></a>              <span class="dt">asc_air  =</span> <span class="dv">0</span>,</span>
<span id="cb1-45"><a href="#cb1-45"></a>              <span class="dt">asc_rail =</span> <span class="dv">0</span>,</span>
<span id="cb1-46"><a href="#cb1-46"></a>              <span class="dt">b_tt_car =</span> <span class="dv">0</span>,</span>
<span id="cb1-47"><a href="#cb1-47"></a>              <span class="dt">b_tt_bus =</span> <span class="dv">0</span>,</span>
<span id="cb1-48"><a href="#cb1-48"></a>              <span class="dt">b_tt_air =</span> <span class="dv">0</span>,</span>
<span id="cb1-49"><a href="#cb1-49"></a>              <span class="dt">b_tt_rail=</span> <span class="dv">0</span>,</span>
<span id="cb1-50"><a href="#cb1-50"></a>              <span class="dt">b_c      =</span> <span class="dv">0</span>)</span>
<span id="cb1-51"><a href="#cb1-51"></a></span>
<span id="cb1-52"><a href="#cb1-52"></a><span class="co">### Vector with names (in quotes) of parameters to be</span></span>
<span id="cb1-53"><a href="#cb1-53"></a><span class="co">###  kept fixed at their starting value in apollo_beta.</span></span>
<span id="cb1-54"><a href="#cb1-54"></a><span class="co">### Use apollo_beta_fixed = c() for no fixed parameters.</span></span>
<span id="cb1-55"><a href="#cb1-55"></a>apollo_fixed =<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;asc_car&quot;</span>)</span>
<span id="cb1-56"><a href="#cb1-56"></a></span>
<span id="cb1-57"><a href="#cb1-57"></a><span class="co"># ####################################################### #</span></span>
<span id="cb1-58"><a href="#cb1-58"></a><span class="co">#### 4. Input validation                               ####</span></span>
<span id="cb1-59"><a href="#cb1-59"></a><span class="co"># ####################################################### #</span></span>
<span id="cb1-60"><a href="#cb1-60"></a></span>
<span id="cb1-61"><a href="#cb1-61"></a>apollo_inputs =<span class="st"> </span><span class="kw">apollo_validateInputs</span>()</span>
<span id="cb1-62"><a href="#cb1-62"></a><span class="co">#&gt; Several observations per individual detected based on the value of ID.</span></span>
<span id="cb1-63"><a href="#cb1-63"></a><span class="co">#&gt;   Setting panelData in apollo_control set to TRUE.</span></span>
<span id="cb1-64"><a href="#cb1-64"></a><span class="co">#&gt; All checks on apollo_control completed.</span></span>
<span id="cb1-65"><a href="#cb1-65"></a><span class="co">#&gt; All checks on database completed.</span></span>
<span id="cb1-66"><a href="#cb1-66"></a></span>
<span id="cb1-67"><a href="#cb1-67"></a><span class="co"># ####################################################### #</span></span>
<span id="cb1-68"><a href="#cb1-68"></a><span class="co">#### 5. Likelihood definition                          ####</span></span>
<span id="cb1-69"><a href="#cb1-69"></a><span class="co"># ####################################################### #</span></span>
<span id="cb1-70"><a href="#cb1-70"></a></span>
<span id="cb1-71"><a href="#cb1-71"></a>apollo_probabilities=<span class="cf">function</span>(apollo_beta, apollo_inputs, </span>
<span id="cb1-72"><a href="#cb1-72"></a>                              <span class="dt">functionality=</span><span class="st">&quot;estimate&quot;</span>){</span>
<span id="cb1-73"><a href="#cb1-73"></a></span>
<span id="cb1-74"><a href="#cb1-74"></a>  <span class="co">### Attach inputs and detach after function exit</span></span>
<span id="cb1-75"><a href="#cb1-75"></a>  <span class="kw">apollo_attach</span>(apollo_beta, apollo_inputs)</span>
<span id="cb1-76"><a href="#cb1-76"></a>  <span class="kw">on.exit</span>(<span class="kw">apollo_detach</span>(apollo_beta, apollo_inputs))</span>
<span id="cb1-77"><a href="#cb1-77"></a></span>
<span id="cb1-78"><a href="#cb1-78"></a>  <span class="co">### Create list of probabilities P</span></span>
<span id="cb1-79"><a href="#cb1-79"></a>  P =<span class="st"> </span><span class="kw">list</span>()</span>
<span id="cb1-80"><a href="#cb1-80"></a>  </span>
<span id="cb1-81"><a href="#cb1-81"></a>  <span class="co">### List of utilities: these must use the same names as</span></span>
<span id="cb1-82"><a href="#cb1-82"></a>  <span class="co">### in mnl_settings, order is irrelevant.</span></span>
<span id="cb1-83"><a href="#cb1-83"></a>  V =<span class="st"> </span><span class="kw">list</span>()</span>
<span id="cb1-84"><a href="#cb1-84"></a>  V[[<span class="st">&#39;car&#39;</span>]] =<span class="st"> </span>asc_car <span class="op">+</span><span class="st"> </span>b_tt_car <span class="op">*</span>time_car <span class="op">+</span><span class="st"> </span>b_c<span class="op">*</span>cost_car</span>
<span id="cb1-85"><a href="#cb1-85"></a>  V[[<span class="st">&#39;bus&#39;</span>]] =<span class="st"> </span>asc_bus <span class="op">+</span><span class="st"> </span>b_tt_bus <span class="op">*</span>time_bus <span class="op">+</span><span class="st"> </span>b_c<span class="op">*</span>cost_bus</span>
<span id="cb1-86"><a href="#cb1-86"></a>  V[[<span class="st">&#39;air&#39;</span>]] =<span class="st"> </span>asc_air <span class="op">+</span><span class="st"> </span>b_tt_air <span class="op">*</span>time_air <span class="op">+</span><span class="st"> </span>b_c<span class="op">*</span>cost_air</span>
<span id="cb1-87"><a href="#cb1-87"></a>  V[[<span class="st">&#39;rail&#39;</span>]]=<span class="st"> </span>asc_rail<span class="op">+</span><span class="st"> </span>b_tt_rail<span class="op">*</span>time_rail<span class="op">+</span><span class="st"> </span>b_c<span class="op">*</span>cost_rail</span>
<span id="cb1-88"><a href="#cb1-88"></a>  </span>
<span id="cb1-89"><a href="#cb1-89"></a>  <span class="co">### Define settings for MNL model component</span></span>
<span id="cb1-90"><a href="#cb1-90"></a>  mnl_settings =<span class="st"> </span><span class="kw">list</span>(</span>
<span id="cb1-91"><a href="#cb1-91"></a>    <span class="dt">alternatives  =</span> <span class="kw">c</span>(<span class="dt">car=</span><span class="dv">1</span>, <span class="dt">bus=</span><span class="dv">2</span>, <span class="dt">air=</span><span class="dv">3</span>, <span class="dt">rail=</span><span class="dv">4</span>), </span>
<span id="cb1-92"><a href="#cb1-92"></a>    <span class="dt">avail         =</span> <span class="kw">list</span>(<span class="dt">car=</span>av_car, <span class="dt">bus=</span>av_bus, </span>
<span id="cb1-93"><a href="#cb1-93"></a>                         <span class="dt">air=</span>av_air, <span class="dt">rail=</span>av_rail), </span>
<span id="cb1-94"><a href="#cb1-94"></a>    <span class="dt">choiceVar     =</span> choice,</span>
<span id="cb1-95"><a href="#cb1-95"></a>    <span class="dt">V             =</span> V</span>
<span id="cb1-96"><a href="#cb1-96"></a>  )</span>
<span id="cb1-97"><a href="#cb1-97"></a>  </span>
<span id="cb1-98"><a href="#cb1-98"></a>  <span class="co">### Compute probabilities using MNL model</span></span>
<span id="cb1-99"><a href="#cb1-99"></a>  P[[<span class="st">&#39;model&#39;</span>]] =<span class="st"> </span><span class="kw">apollo_mnl</span>(mnl_settings, functionality)</span>
<span id="cb1-100"><a href="#cb1-100"></a></span>
<span id="cb1-101"><a href="#cb1-101"></a>  <span class="co">### Take product across observation for same individual</span></span>
<span id="cb1-102"><a href="#cb1-102"></a>  P =<span class="st"> </span><span class="kw">apollo_panelProd</span>(P, apollo_inputs, functionality)</span>
<span id="cb1-103"><a href="#cb1-103"></a></span>
<span id="cb1-104"><a href="#cb1-104"></a>  <span class="co">### Prepare and return outputs of function</span></span>
<span id="cb1-105"><a href="#cb1-105"></a>  P =<span class="st"> </span><span class="kw">apollo_prepareProb</span>(P, apollo_inputs, functionality)</span>
<span id="cb1-106"><a href="#cb1-106"></a>  <span class="kw">return</span>(P)</span>
<span id="cb1-107"><a href="#cb1-107"></a>}</span>
<span id="cb1-108"><a href="#cb1-108"></a></span>
<span id="cb1-109"><a href="#cb1-109"></a><span class="co"># ####################################################### #</span></span>
<span id="cb1-110"><a href="#cb1-110"></a><span class="co">#### 6. Model estimation and reporting                 ####</span></span>
<span id="cb1-111"><a href="#cb1-111"></a><span class="co"># ####################################################### #</span></span>
<span id="cb1-112"><a href="#cb1-112"></a></span>
<span id="cb1-113"><a href="#cb1-113"></a>model =<span class="st"> </span><span class="kw">apollo_estimate</span>(apollo_beta, apollo_fixed, </span>
<span id="cb1-114"><a href="#cb1-114"></a>                        apollo_probabilities, </span>
<span id="cb1-115"><a href="#cb1-115"></a>                        apollo_inputs)</span>
<span id="cb1-116"><a href="#cb1-116"></a><span class="co">#&gt; </span></span>
<span id="cb1-117"><a href="#cb1-117"></a><span class="co">#&gt; Testing likelihood function...</span></span>
<span id="cb1-118"><a href="#cb1-118"></a><span class="co">#&gt; </span></span>
<span id="cb1-119"><a href="#cb1-119"></a><span class="co">#&gt; Overview of choices for MNL model component :</span></span>
<span id="cb1-120"><a href="#cb1-120"></a><span class="co">#&gt;                                      car     bus     air    rail</span></span>
<span id="cb1-121"><a href="#cb1-121"></a><span class="co">#&gt; Times available                  5446.00 6314.00 5264.00 6118.00</span></span>
<span id="cb1-122"><a href="#cb1-122"></a><span class="co">#&gt; Times chosen                     1946.00  358.00 1522.00 3174.00</span></span>
<span id="cb1-123"><a href="#cb1-123"></a><span class="co">#&gt; Percentage chosen overall          27.80    5.11   21.74   45.34</span></span>
<span id="cb1-124"><a href="#cb1-124"></a><span class="co">#&gt; Percentage chosen when available   35.73    5.67   28.91   51.88</span></span>
<span id="cb1-125"><a href="#cb1-125"></a><span class="co">#&gt; </span></span>
<span id="cb1-126"><a href="#cb1-126"></a><span class="co">#&gt; Pre-processing likelihood function...</span></span>
<span id="cb1-127"><a href="#cb1-127"></a><span class="co">#&gt; </span></span>
<span id="cb1-128"><a href="#cb1-128"></a><span class="co">#&gt; Testing influence of parameters........</span></span>
<span id="cb1-129"><a href="#cb1-129"></a><span class="co">#&gt; Starting main estimation</span></span>
<span id="cb1-130"><a href="#cb1-130"></a><span class="co">#&gt; Initial function value: -8196.021 </span></span>
<span id="cb1-131"><a href="#cb1-131"></a><span class="co">#&gt; Initial gradient value:</span></span>
<span id="cb1-132"><a href="#cb1-132"></a><span class="co">#&gt;     asc_bus     asc_air    asc_rail    b_tt_car    b_tt_bus    b_tt_air </span></span>
<span id="cb1-133"><a href="#cb1-133"></a><span class="co">#&gt;   -1599.667     -39.000    1302.667   92447.083 -597397.500   -1820.833 </span></span>
<span id="cb1-134"><a href="#cb1-134"></a><span class="co">#&gt;   b_tt_rail         b_c </span></span>
<span id="cb1-135"><a href="#cb1-135"></a><span class="co">#&gt;  189332.083    8862.500 </span></span>
<span id="cb1-136"><a href="#cb1-136"></a><span class="co">#&gt; initial  value 8196.020532 </span></span>
<span id="cb1-137"><a href="#cb1-137"></a><span class="co">#&gt; iter   2 value 7456.688616</span></span>
<span id="cb1-138"><a href="#cb1-138"></a><span class="co">#&gt; iter   3 value 7375.154804</span></span>
<span id="cb1-139"><a href="#cb1-139"></a><span class="co">#&gt; iter   4 value 7260.844458</span></span>
<span id="cb1-140"><a href="#cb1-140"></a><span class="co">#&gt; iter   5 value 6670.816185</span></span>
<span id="cb1-141"><a href="#cb1-141"></a><span class="co">#&gt; iter   6 value 6618.448409</span></span>
<span id="cb1-142"><a href="#cb1-142"></a><span class="co">#&gt; iter   7 value 6471.224869</span></span>
<span id="cb1-143"><a href="#cb1-143"></a><span class="co">#&gt; iter   8 value 6429.069421</span></span>
<span id="cb1-144"><a href="#cb1-144"></a><span class="co">#&gt; iter   9 value 6216.357850</span></span>
<span id="cb1-145"><a href="#cb1-145"></a><span class="co">#&gt; iter  10 value 6052.604883</span></span>
<span id="cb1-146"><a href="#cb1-146"></a><span class="co">#&gt; iter  11 value 5838.718102</span></span>
<span id="cb1-147"><a href="#cb1-147"></a><span class="co">#&gt; iter  12 value 5815.462110</span></span>
<span id="cb1-148"><a href="#cb1-148"></a><span class="co">#&gt; iter  13 value 5804.515623</span></span>
<span id="cb1-149"><a href="#cb1-149"></a><span class="co">#&gt; iter  14 value 5802.299705</span></span>
<span id="cb1-150"><a href="#cb1-150"></a><span class="co">#&gt; iter  15 value 5802.031103</span></span>
<span id="cb1-151"><a href="#cb1-151"></a><span class="co">#&gt; iter  16 value 5802.023289</span></span>
<span id="cb1-152"><a href="#cb1-152"></a><span class="co">#&gt; iter  17 value 5802.022828</span></span>
<span id="cb1-153"><a href="#cb1-153"></a><span class="co">#&gt; iter  17 value 5802.022826</span></span>
<span id="cb1-154"><a href="#cb1-154"></a><span class="co">#&gt; iter  17 value 5802.022826</span></span>
<span id="cb1-155"><a href="#cb1-155"></a><span class="co">#&gt; final  value 5802.022826 </span></span>
<span id="cb1-156"><a href="#cb1-156"></a><span class="co">#&gt; converged</span></span>
<span id="cb1-157"><a href="#cb1-157"></a><span class="co">#&gt; Estimated parameters:</span></span>
<span id="cb1-158"><a href="#cb1-158"></a><span class="co">#&gt;              Estimate</span></span>
<span id="cb1-159"><a href="#cb1-159"></a><span class="co">#&gt; asc_car      0.000000</span></span>
<span id="cb1-160"><a href="#cb1-160"></a><span class="co">#&gt; asc_bus      0.011545</span></span>
<span id="cb1-161"><a href="#cb1-161"></a><span class="co">#&gt; asc_air     -0.649537</span></span>
<span id="cb1-162"><a href="#cb1-162"></a><span class="co">#&gt; asc_rail    -1.235710</span></span>
<span id="cb1-163"><a href="#cb1-163"></a><span class="co">#&gt; b_tt_car    -0.010061</span></span>
<span id="cb1-164"><a href="#cb1-164"></a><span class="co">#&gt; b_tt_bus    -0.016422</span></span>
<span id="cb1-165"><a href="#cb1-165"></a><span class="co">#&gt; b_tt_air    -0.011831</span></span>
<span id="cb1-166"><a href="#cb1-166"></a><span class="co">#&gt; b_tt_rail   -0.004780</span></span>
<span id="cb1-167"><a href="#cb1-167"></a><span class="co">#&gt; b_c         -0.052923</span></span>
<span id="cb1-168"><a href="#cb1-168"></a><span class="co">#&gt; </span></span>
<span id="cb1-169"><a href="#cb1-169"></a><span class="co">#&gt; Computing covariance matrix using analytical gradient.</span></span>
<span id="cb1-170"><a href="#cb1-170"></a><span class="co">#&gt;  0%....25%....50%....75%.100%</span></span>
<span id="cb1-171"><a href="#cb1-171"></a><span class="co">#&gt; Negative definite Hessian with maximum eigenvalue: -3.304559</span></span>
<span id="cb1-172"><a href="#cb1-172"></a><span class="co">#&gt; Computing score matrix...</span></span>
<span id="cb1-173"><a href="#cb1-173"></a><span class="co">#&gt; Calculating LL(0)...</span></span>
<span id="cb1-174"><a href="#cb1-174"></a><span class="co">#&gt; Calculating LL of each model component...</span></span>
<span id="cb1-175"><a href="#cb1-175"></a></span>
<span id="cb1-176"><a href="#cb1-176"></a><span class="kw">apollo_modelOutput</span>(model)</span>
<span id="cb1-177"><a href="#cb1-177"></a><span class="co">#&gt; Model run using Apollo for R, version 0.2.2 on Linux by david </span></span>
<span id="cb1-178"><a href="#cb1-178"></a><span class="co">#&gt; www.ApolloChoiceModelling.com</span></span>
<span id="cb1-179"><a href="#cb1-179"></a><span class="co">#&gt; </span></span>
<span id="cb1-180"><a href="#cb1-180"></a><span class="co">#&gt; Model name                       : MNL</span></span>
<span id="cb1-181"><a href="#cb1-181"></a><span class="co">#&gt; Model description                : Simple MNL model on mode choice SP data</span></span>
<span id="cb1-182"><a href="#cb1-182"></a><span class="co">#&gt; Model run at                     : 2020-12-05 17:33:06</span></span>
<span id="cb1-183"><a href="#cb1-183"></a><span class="co">#&gt; Estimation method                : bfgs</span></span>
<span id="cb1-184"><a href="#cb1-184"></a><span class="co">#&gt; Model diagnosis                  : successful convergence </span></span>
<span id="cb1-185"><a href="#cb1-185"></a><span class="co">#&gt; Number of individuals            : 500</span></span>
<span id="cb1-186"><a href="#cb1-186"></a><span class="co">#&gt; Number of rows in database       : 7000</span></span>
<span id="cb1-187"><a href="#cb1-187"></a><span class="co">#&gt; Number of modelled outcomes      : 7000</span></span>
<span id="cb1-188"><a href="#cb1-188"></a><span class="co">#&gt; </span></span>
<span id="cb1-189"><a href="#cb1-189"></a><span class="co">#&gt; Number of cores used             :  1 </span></span>
<span id="cb1-190"><a href="#cb1-190"></a><span class="co">#&gt; Model without mixing</span></span>
<span id="cb1-191"><a href="#cb1-191"></a><span class="co">#&gt; </span></span>
<span id="cb1-192"><a href="#cb1-192"></a><span class="co">#&gt; LL(start)                        : -8196.021</span></span>
<span id="cb1-193"><a href="#cb1-193"></a><span class="co">#&gt; LL(0)                            : -8196.021</span></span>
<span id="cb1-194"><a href="#cb1-194"></a><span class="co">#&gt; LL(final)                        : -5802.023</span></span>
<span id="cb1-195"><a href="#cb1-195"></a><span class="co">#&gt; Rho-square (0)                   :  0.2921 </span></span>
<span id="cb1-196"><a href="#cb1-196"></a><span class="co">#&gt; Adj.Rho-square (0)               :  0.2911 </span></span>
<span id="cb1-197"><a href="#cb1-197"></a><span class="co">#&gt; AIC                              :  11620.05 </span></span>
<span id="cb1-198"><a href="#cb1-198"></a><span class="co">#&gt; BIC                              :  11674.87 </span></span>
<span id="cb1-199"><a href="#cb1-199"></a><span class="co">#&gt; </span></span>
<span id="cb1-200"><a href="#cb1-200"></a><span class="co">#&gt; </span></span>
<span id="cb1-201"><a href="#cb1-201"></a><span class="co">#&gt; Estimated parameters             :  8</span></span>
<span id="cb1-202"><a href="#cb1-202"></a><span class="co">#&gt; Time taken (hh:mm:ss)            :  00:00:1.67 </span></span>
<span id="cb1-203"><a href="#cb1-203"></a><span class="co">#&gt;      pre-estimation              :  00:00:0.54 </span></span>
<span id="cb1-204"><a href="#cb1-204"></a><span class="co">#&gt;      estimation                  :  00:00:0.55 </span></span>
<span id="cb1-205"><a href="#cb1-205"></a><span class="co">#&gt;      post-estimation             :  00:00:0.58 </span></span>
<span id="cb1-206"><a href="#cb1-206"></a><span class="co">#&gt; Iterations                       :  19  </span></span>
<span id="cb1-207"><a href="#cb1-207"></a><span class="co">#&gt; Min abs eigenvalue of Hessian    :  3.304559 </span></span>
<span id="cb1-208"><a href="#cb1-208"></a><span class="co">#&gt; </span></span>
<span id="cb1-209"><a href="#cb1-209"></a><span class="co">#&gt; Estimates:</span></span>
<span id="cb1-210"><a href="#cb1-210"></a><span class="co">#&gt;              Estimate        s.e.   t.rat.(0)    Rob.s.e. Rob.t.rat.(0)</span></span>
<span id="cb1-211"><a href="#cb1-211"></a><span class="co">#&gt; asc_car      0.000000          NA          NA          NA            NA</span></span>
<span id="cb1-212"><a href="#cb1-212"></a><span class="co">#&gt; asc_bus      0.011545    0.540840     0.02135    0.541642       0.02132</span></span>
<span id="cb1-213"><a href="#cb1-213"></a><span class="co">#&gt; asc_air     -0.649537    0.269903    -2.40655    0.266912      -2.43352</span></span>
<span id="cb1-214"><a href="#cb1-214"></a><span class="co">#&gt; asc_rail    -1.235710    0.321846    -3.83945    0.312775      -3.95079</span></span>
<span id="cb1-215"><a href="#cb1-215"></a><span class="co">#&gt; b_tt_car    -0.010061  6.3867e-04   -15.75317  6.5823e-04     -15.28521</span></span>
<span id="cb1-216"><a href="#cb1-216"></a><span class="co">#&gt; b_tt_bus    -0.016422    0.001453   -11.30290    0.001480     -11.09958</span></span>
<span id="cb1-217"><a href="#cb1-217"></a><span class="co">#&gt; b_tt_air    -0.011831    0.002402    -4.92625    0.002370      -4.99136</span></span>
<span id="cb1-218"><a href="#cb1-218"></a><span class="co">#&gt; b_tt_rail   -0.004780    0.001650    -2.89736    0.001623      -2.94432</span></span>
<span id="cb1-219"><a href="#cb1-219"></a><span class="co">#&gt; b_c         -0.052923    0.001422   -37.21129    0.001701     -31.11201</span></span>
<span id="cb1-220"><a href="#cb1-220"></a></span>
<span id="cb1-221"><a href="#cb1-221"></a><span class="co">#apollo_saveOutput(model)</span></span>
<span id="cb1-222"><a href="#cb1-222"></a></span>
<span id="cb1-223"><a href="#cb1-223"></a><span class="co"># ####################################################### #</span></span>
<span id="cb1-224"><a href="#cb1-224"></a><span class="co">#### 7. Postprocessing of results                      ####</span></span>
<span id="cb1-225"><a href="#cb1-225"></a><span class="co"># ####################################################### #</span></span>
<span id="cb1-226"><a href="#cb1-226"></a></span>
<span id="cb1-227"><a href="#cb1-227"></a><span class="co">### Use the estimated model to make predictions</span></span>
<span id="cb1-228"><a href="#cb1-228"></a>predictions_base =<span class="st"> </span><span class="kw">apollo_prediction</span>(model, </span>
<span id="cb1-229"><a href="#cb1-229"></a>                                     apollo_probabilities, </span>
<span id="cb1-230"><a href="#cb1-230"></a>                                     apollo_inputs)</span>
<span id="cb1-231"><a href="#cb1-231"></a><span class="co">#&gt; Running predictions from model using parameter estimates...</span></span>
<span id="cb1-232"><a href="#cb1-232"></a><span class="co">#&gt; Predicted aggregated demand at model estimates</span></span>
<span id="cb1-233"><a href="#cb1-233"></a><span class="co">#&gt;         car bus  air rail</span></span>
<span id="cb1-234"><a href="#cb1-234"></a><span class="co">#&gt; Demand 1946 358 1522 3174</span></span>
<span id="cb1-235"><a href="#cb1-235"></a><span class="co">#&gt; </span></span>
<span id="cb1-236"><a href="#cb1-236"></a><span class="co">#&gt; The output from apollo_prediction is a matrix containing the</span></span>
<span id="cb1-237"><a href="#cb1-237"></a><span class="co">#&gt;   predictions at the estimated values.</span></span>
<span id="cb1-238"><a href="#cb1-238"></a></span>
<span id="cb1-239"><a href="#cb1-239"></a><span class="co">### Now imagine the cost for rail increases by 10% </span></span>
<span id="cb1-240"><a href="#cb1-240"></a><span class="co">### and predict again</span></span>
<span id="cb1-241"><a href="#cb1-241"></a>database<span class="op">$</span>cost_rail =<span class="st"> </span><span class="fl">1.1</span><span class="op">*</span>database<span class="op">$</span>cost_rail</span>
<span id="cb1-242"><a href="#cb1-242"></a>apollo_inputs   =<span class="st"> </span><span class="kw">apollo_validateInputs</span>()</span>
<span id="cb1-243"><a href="#cb1-243"></a><span class="co">#&gt; Several observations per individual detected based on the value of ID.</span></span>
<span id="cb1-244"><a href="#cb1-244"></a><span class="co">#&gt;   Setting panelData in apollo_control set to TRUE.</span></span>
<span id="cb1-245"><a href="#cb1-245"></a><span class="co">#&gt; All checks on apollo_control completed.</span></span>
<span id="cb1-246"><a href="#cb1-246"></a><span class="co">#&gt; All checks on database completed.</span></span>
<span id="cb1-247"><a href="#cb1-247"></a>predictions_new =<span class="st"> </span><span class="kw">apollo_prediction</span>(model, </span>
<span id="cb1-248"><a href="#cb1-248"></a>                                    apollo_probabilities, </span>
<span id="cb1-249"><a href="#cb1-249"></a>                                    apollo_inputs)</span>
<span id="cb1-250"><a href="#cb1-250"></a><span class="co">#&gt; Running predictions from model using parameter estimates...</span></span>
<span id="cb1-251"><a href="#cb1-251"></a><span class="co">#&gt; Predicted aggregated demand at model estimates</span></span>
<span id="cb1-252"><a href="#cb1-252"></a><span class="co">#&gt;            car    bus     air    rail</span></span>
<span id="cb1-253"><a href="#cb1-253"></a><span class="co">#&gt; Demand 2132.59 399.33 1645.75 2822.34</span></span>
<span id="cb1-254"><a href="#cb1-254"></a><span class="co">#&gt; </span></span>
<span id="cb1-255"><a href="#cb1-255"></a><span class="co">#&gt; The output from apollo_prediction is a matrix containing the</span></span>
<span id="cb1-256"><a href="#cb1-256"></a><span class="co">#&gt;   predictions at the estimated values.</span></span>
<span id="cb1-257"><a href="#cb1-257"></a></span>
<span id="cb1-258"><a href="#cb1-258"></a><span class="co">### Compare predictions</span></span>
<span id="cb1-259"><a href="#cb1-259"></a>change=(predictions_new<span class="op">-</span>predictions_base)<span class="op">/</span>predictions_base</span>
<span id="cb1-260"><a href="#cb1-260"></a><span class="co">### Not interested in chosen alternative now, </span></span>
<span id="cb1-261"><a href="#cb1-261"></a><span class="co">### so drop last column</span></span>
<span id="cb1-262"><a href="#cb1-262"></a>change=change[,<span class="op">-</span><span class="kw">ncol</span>(change)]</span>
<span id="cb1-263"><a href="#cb1-263"></a><span class="co">### Summary of changes (possible presence of NAs due to</span></span>
<span id="cb1-264"><a href="#cb1-264"></a><span class="co">### unavailable alternatives)</span></span>
<span id="cb1-265"><a href="#cb1-265"></a><span class="kw">summary</span>(change)</span>
<span id="cb1-266"><a href="#cb1-266"></a><span class="co">#&gt;        ID     Observation      car              bus              air        </span></span>
<span id="cb1-267"><a href="#cb1-267"></a><span class="co">#&gt;  Min.   :0   Min.   :0    Min.   :0.0000   Min.   :0.0000   Min.   :0.0000  </span></span>
<span id="cb1-268"><a href="#cb1-268"></a><span class="co">#&gt;  1st Qu.:0   1st Qu.:0    1st Qu.:0.0725   1st Qu.:0.0738   1st Qu.:0.0704  </span></span>
<span id="cb1-269"><a href="#cb1-269"></a><span class="co">#&gt;  Median :0   Median :0    Median :0.1168   Median :0.1218   Median :0.1100  </span></span>
<span id="cb1-270"><a href="#cb1-270"></a><span class="co">#&gt;  Mean   :0   Mean   :0    Mean   :0.1105   Mean   :0.1225   Mean   :0.1121  </span></span>
<span id="cb1-271"><a href="#cb1-271"></a><span class="co">#&gt;  3rd Qu.:0   3rd Qu.:0    3rd Qu.:0.1509   3rd Qu.:0.1674   3rd Qu.:0.1517  </span></span>
<span id="cb1-272"><a href="#cb1-272"></a><span class="co">#&gt;  Max.   :0   Max.   :0    Max.   :0.2339   Max.   :0.4326   Max.   :0.3677  </span></span>
<span id="cb1-273"><a href="#cb1-273"></a><span class="co">#&gt;                           NA&#39;s   :1554     NA&#39;s   :686      NA&#39;s   :1736    </span></span>
<span id="cb1-274"><a href="#cb1-274"></a><span class="co">#&gt;       rail        </span></span>
<span id="cb1-275"><a href="#cb1-275"></a><span class="co">#&gt;  Min.   :-0.3028  </span></span>
<span id="cb1-276"><a href="#cb1-276"></a><span class="co">#&gt;  1st Qu.:-0.2060  </span></span>
<span id="cb1-277"><a href="#cb1-277"></a><span class="co">#&gt;  Median :-0.1340  </span></span>
<span id="cb1-278"><a href="#cb1-278"></a><span class="co">#&gt;  Mean   :-0.1434  </span></span>
<span id="cb1-279"><a href="#cb1-279"></a><span class="co">#&gt;  3rd Qu.:-0.0723  </span></span>
<span id="cb1-280"><a href="#cb1-280"></a><span class="co">#&gt;  Max.   :-0.0022  </span></span>
<span id="cb1-281"><a href="#cb1-281"></a><span class="co">#&gt;  NA&#39;s   :882</span></span></code></pre></div>
</div>
<div id="mmnl-model-file-example" class="section level2">
<h2>MMNL model file example</h2>
<p>In this section, we present code to estimate a mixed MNL model (MMNL) using the synthetic data included in the package. After estimation, we predict the effect of a 10% increase in the train fares. The utility function of the model remains the same than in the previous example, i.e.:</p>
<p><span class="math display">\[U_{nsi} = asc_i + \beta_{tt}tt_{nsi} + \beta_{c}*cost_{nsi} + \varepsilon_{nsi}\]</span></p>
<p>Where <em>n</em> indexes individuals, <em>s</em> choice scenarios, and <em>i</em> alternatives. <span class="math inline">\(asc_i\)</span> is the alternative specific constant, <span class="math inline">\(tt_{nsi}\)</span> is the travel time and <span class="math inline">\(cost_{nsi}\)</span> is the cost. <span class="math inline">\(\varepsilon_{nsi}\)</span> is an independent identically distributed standard Gumbel error term. <span class="math inline">\(\beta_{tt}\)</span> follows a log-normal distribution with the underlying normal having a mean <span class="math inline">\(\mu_{tt}\)</span> and standard deviation <span class="math inline">\(\sigma_{tt}\)</span>. <span class="math inline">\(asc_i\)</span>, <span class="math inline">\(\beta_{c}\)</span>, <span class="math inline">\(\mu_{tt}\)</span> and <span class="math inline">\(\sigma_{tt}\)</span> are parameters to be estimated.</p>
<p>The likelihood function of this model for individual <span class="math inline">\(n\)</span> is as follows.</p>
<p><span class="math display">\[L_{n}=\int_{\beta_{tt}}\prod_{s}P_{nsi}f(\beta_{tt})d\beta_{tt}\]</span></p>
<p>Where <span class="math inline">\(P_{nsi}=\frac{e^{V_{nsi}}}{\sum_{j}e^{V_{nsj}}}\)</span>, <span class="math inline">\(V_{nsi}=U_{nsi}-\varepsilon_{nsi}\)</span>, and <span class="math inline">\(f\)</span> is the probability density function of <span class="math inline">\(\beta_{tt}\)</span>. As this function does not have an analytical closed form, we estimate it using Monte Carlo integration, i.e.:</p>
<p><span class="math display">\[L_{n}\approx\frac{1}{R}\sum_{\beta_{tt}^r}\prod_{s}P_{nsi}^r\]</span> Where <span class="math inline">\(P_{nsi}^r=P_{nsi}(\beta_{tt}^r)\)</span>, with <span class="math inline">\(\beta_{tt}^r\)</span> a random draw of <span class="math inline">\(\beta_{tt}\)</span> from its distribution <span class="math inline">\(f\)</span>, and R is a big number.</p>
<p>The code is very similar to the previous example, with only sections 1 and 3 changing. * In section 1 we set <code>mixing = TRUE</code> inside apollo_control, and we set <code>nCores = 2</code> to speed up estimation by using two computing threads (this is not mandatory). * In section 3 we define the mean (<code>b_tt_mu</code>) and standar deviation (<code>b_tt_sigma</code>) of the underlying normal distribution. We then define the type, name and number of draws used. Finally, we construct the random coefficient <span class="math inline">\(\beta_{tt}\)</span> inside a function called <code>apollo_randCoeff</code>. We use 500 inter-individual draws that come from a standard normal distribution, which we later transform into log-normals inside <code>apollo_randCoeff</code>.</p>
<p>Even though in this case we only use <em>inter</em>-individual draws, note that <em>inter</em> and <em>intra</em>-individuals draws can be used simultaneously. <em>Inter</em>-individual draws capture variability <em>between</em> individuals, while <em>intra</em>-individual draws capture variability <em>within</em> individuals. In terms of the Monte Carlo integration, <em>inter</em>-individual draws are common for all observations from the same individual, while <em>intra</em>-individual draws are different for each observations. In terms of the likelihood function, the use of <em>intra</em>-individual draws would lead to <span class="math inline">\(L_{n}\approx\prod_{s}\frac{1}{R}\sum_{\beta_{tt}^r}P_{nsi}\)</span>, which is <strong>not</strong> the case in this model.</p>
<p>Estimation of models with mixing is computationally more demanding than models without mixing. Furthermore, using both <em>inter</em> and <em>intra</em>-individual requires large amounts of memory, which can further slow the estimation process. For this reason, this example is not run automatically. Yet, the users may copy and paste the code in a script, and run it themselves.</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1"></a><span class="co"># ####################################################### #</span></span>
<span id="cb2-2"><a href="#cb2-2"></a><span class="co">#### 1. Definition of core settings                        </span></span>
<span id="cb2-3"><a href="#cb2-3"></a><span class="co"># ####################################################### #</span></span>
<span id="cb2-4"><a href="#cb2-4"></a></span>
<span id="cb2-5"><a href="#cb2-5"></a><span class="co">### Clear memory</span></span>
<span id="cb2-6"><a href="#cb2-6"></a><span class="kw">rm</span>(<span class="dt">list =</span> <span class="kw">ls</span>())</span>
<span id="cb2-7"><a href="#cb2-7"></a></span>
<span id="cb2-8"><a href="#cb2-8"></a><span class="co">### Load libraries</span></span>
<span id="cb2-9"><a href="#cb2-9"></a><span class="kw">library</span>(apollo)</span>
<span id="cb2-10"><a href="#cb2-10"></a></span>
<span id="cb2-11"><a href="#cb2-11"></a><span class="co">### Initialise code</span></span>
<span id="cb2-12"><a href="#cb2-12"></a><span class="kw">apollo_initialise</span>()</span>
<span id="cb2-13"><a href="#cb2-13"></a></span>
<span id="cb2-14"><a href="#cb2-14"></a><span class="co">### Set core controls</span></span>
<span id="cb2-15"><a href="#cb2-15"></a>apollo_control =<span class="st"> </span><span class="kw">list</span>(</span>
<span id="cb2-16"><a href="#cb2-16"></a>  <span class="dt">modelName  =</span><span class="st">&quot;MMNL&quot;</span>,</span>
<span id="cb2-17"><a href="#cb2-17"></a>  <span class="dt">modelDescr =</span><span class="st">&quot;Simple MMNL model on mode choice SP data&quot;</span>,</span>
<span id="cb2-18"><a href="#cb2-18"></a>  <span class="dt">indivID    =</span><span class="st">&quot;ID&quot;</span>,</span>
<span id="cb2-19"><a href="#cb2-19"></a>  <span class="dt">mixing     =</span> <span class="ot">TRUE</span>,</span>
<span id="cb2-20"><a href="#cb2-20"></a>  <span class="dt">nCores     =</span> <span class="dv">2</span></span>
<span id="cb2-21"><a href="#cb2-21"></a>)</span>
<span id="cb2-22"><a href="#cb2-22"></a></span>
<span id="cb2-23"><a href="#cb2-23"></a><span class="co"># ####################################################### #</span></span>
<span id="cb2-24"><a href="#cb2-24"></a><span class="co">#### 2. Data loading                                   ####</span></span>
<span id="cb2-25"><a href="#cb2-25"></a><span class="co"># ####################################################### #</span></span>
<span id="cb2-26"><a href="#cb2-26"></a></span>
<span id="cb2-27"><a href="#cb2-27"></a><span class="kw">data</span>(<span class="st">&quot;apollo_modeChoiceData&quot;</span>, <span class="dt">package=</span><span class="st">&quot;apollo&quot;</span>)</span>
<span id="cb2-28"><a href="#cb2-28"></a>database =<span class="st"> </span>apollo_modeChoiceData</span>
<span id="cb2-29"><a href="#cb2-29"></a><span class="kw">rm</span>(apollo_modeChoiceData)</span>
<span id="cb2-30"><a href="#cb2-30"></a></span>
<span id="cb2-31"><a href="#cb2-31"></a><span class="co">### Use only SP data</span></span>
<span id="cb2-32"><a href="#cb2-32"></a>database =<span class="st"> </span><span class="kw">subset</span>(database,database<span class="op">$</span>SP<span class="op">==</span><span class="dv">1</span>)</span>
<span id="cb2-33"><a href="#cb2-33"></a></span>
<span id="cb2-34"><a href="#cb2-34"></a><span class="co">### Create new variable with average income</span></span>
<span id="cb2-35"><a href="#cb2-35"></a>database<span class="op">$</span>mean_income =<span class="st"> </span><span class="kw">mean</span>(database<span class="op">$</span>income)</span>
<span id="cb2-36"><a href="#cb2-36"></a></span>
<span id="cb2-37"><a href="#cb2-37"></a><span class="co"># ####################################################### #</span></span>
<span id="cb2-38"><a href="#cb2-38"></a><span class="co">#### 3. Parameter definition                           ####</span></span>
<span id="cb2-39"><a href="#cb2-39"></a><span class="co"># ####################################################### #</span></span>
<span id="cb2-40"><a href="#cb2-40"></a></span>
<span id="cb2-41"><a href="#cb2-41"></a><span class="co">### Vector of parameters, including any that are kept fixed </span></span>
<span id="cb2-42"><a href="#cb2-42"></a><span class="co">### during estimation</span></span>
<span id="cb2-43"><a href="#cb2-43"></a>apollo_beta=<span class="kw">c</span>(<span class="dt">asc_car  =</span> <span class="dv">0</span>,</span>
<span id="cb2-44"><a href="#cb2-44"></a>              <span class="dt">asc_bus  =</span><span class="op">-</span><span class="dv">2</span>,</span>
<span id="cb2-45"><a href="#cb2-45"></a>              <span class="dt">asc_air  =</span><span class="op">-</span><span class="dv">1</span>,</span>
<span id="cb2-46"><a href="#cb2-46"></a>              <span class="dt">asc_rail =</span><span class="op">-</span><span class="dv">1</span>,</span>
<span id="cb2-47"><a href="#cb2-47"></a>              <span class="dt">mu_tt    =</span><span class="op">-</span><span class="dv">4</span>,</span>
<span id="cb2-48"><a href="#cb2-48"></a>              <span class="dt">sigma_tt =</span> <span class="dv">0</span>,</span>
<span id="cb2-49"><a href="#cb2-49"></a>              <span class="dt">b_c      =</span> <span class="dv">0</span>)</span>
<span id="cb2-50"><a href="#cb2-50"></a></span>
<span id="cb2-51"><a href="#cb2-51"></a><span class="co">### Vector with names (in quotes) of parameters to be</span></span>
<span id="cb2-52"><a href="#cb2-52"></a><span class="co">###  kept fixed at their starting value in apollo_beta.</span></span>
<span id="cb2-53"><a href="#cb2-53"></a><span class="co">### Use apollo_beta_fixed = c() for no fixed parameters.</span></span>
<span id="cb2-54"><a href="#cb2-54"></a>apollo_fixed =<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;asc_car&quot;</span>)</span>
<span id="cb2-55"><a href="#cb2-55"></a></span>
<span id="cb2-56"><a href="#cb2-56"></a><span class="co">### Set parameters for generating draws</span></span>
<span id="cb2-57"><a href="#cb2-57"></a>apollo_draws =<span class="st"> </span><span class="kw">list</span>(</span>
<span id="cb2-58"><a href="#cb2-58"></a>  <span class="dt">interDrawsType =</span> <span class="st">&quot;halton&quot;</span>,</span>
<span id="cb2-59"><a href="#cb2-59"></a>  <span class="dt">interNDraws    =</span> <span class="dv">500</span>,</span>
<span id="cb2-60"><a href="#cb2-60"></a>  <span class="dt">interUnifDraws =</span> <span class="kw">c</span>(),</span>
<span id="cb2-61"><a href="#cb2-61"></a>  <span class="dt">interNormDraws =</span> <span class="kw">c</span>(<span class="st">&quot;draws_tt&quot;</span>),</span>
<span id="cb2-62"><a href="#cb2-62"></a>  <span class="dt">intraDrawsType =</span> <span class="st">&quot;halton&quot;</span>,</span>
<span id="cb2-63"><a href="#cb2-63"></a>  <span class="dt">intraNDraws    =</span> <span class="dv">0</span>,</span>
<span id="cb2-64"><a href="#cb2-64"></a>  <span class="dt">intraUnifDraws =</span> <span class="kw">c</span>(),</span>
<span id="cb2-65"><a href="#cb2-65"></a>  <span class="dt">intraNormDraws =</span> <span class="kw">c</span>()</span>
<span id="cb2-66"><a href="#cb2-66"></a>)</span>
<span id="cb2-67"><a href="#cb2-67"></a></span>
<span id="cb2-68"><a href="#cb2-68"></a><span class="co">### Create random parameters</span></span>
<span id="cb2-69"><a href="#cb2-69"></a>apollo_randCoeff =<span class="st"> </span><span class="cf">function</span>(apollo_beta, apollo_inputs){</span>
<span id="cb2-70"><a href="#cb2-70"></a>  randcoeff =<span class="st"> </span><span class="kw">list</span>()</span>
<span id="cb2-71"><a href="#cb2-71"></a>  </span>
<span id="cb2-72"><a href="#cb2-72"></a>  randcoeff[[<span class="st">&quot;b_tt&quot;</span>]] =<span class="st"> </span><span class="op">-</span><span class="kw">exp</span>(mu_tt <span class="op">+</span><span class="st"> </span>sigma_tt<span class="op">*</span>draws_tt)</span>
<span id="cb2-73"><a href="#cb2-73"></a>  </span>
<span id="cb2-74"><a href="#cb2-74"></a>  <span class="kw">return</span>(randcoeff)</span>
<span id="cb2-75"><a href="#cb2-75"></a>}</span>
<span id="cb2-76"><a href="#cb2-76"></a></span>
<span id="cb2-77"><a href="#cb2-77"></a><span class="co"># ####################################################### #</span></span>
<span id="cb2-78"><a href="#cb2-78"></a><span class="co">#### 4. Input validation                               ####</span></span>
<span id="cb2-79"><a href="#cb2-79"></a><span class="co"># ####################################################### #</span></span>
<span id="cb2-80"><a href="#cb2-80"></a></span>
<span id="cb2-81"><a href="#cb2-81"></a>apollo_inputs =<span class="st"> </span><span class="kw">apollo_validateInputs</span>()</span>
<span id="cb2-82"><a href="#cb2-82"></a></span>
<span id="cb2-83"><a href="#cb2-83"></a><span class="co"># ####################################################### #</span></span>
<span id="cb2-84"><a href="#cb2-84"></a><span class="co">#### 5. Likelihood definition                          ####</span></span>
<span id="cb2-85"><a href="#cb2-85"></a><span class="co"># ####################################################### #</span></span>
<span id="cb2-86"><a href="#cb2-86"></a></span>
<span id="cb2-87"><a href="#cb2-87"></a>apollo_probabilities=<span class="cf">function</span>(apollo_beta, apollo_inputs, </span>
<span id="cb2-88"><a href="#cb2-88"></a>                              <span class="dt">functionality=</span><span class="st">&quot;estimate&quot;</span>){</span>
<span id="cb2-89"><a href="#cb2-89"></a>  </span>
<span id="cb2-90"><a href="#cb2-90"></a>  <span class="co">### Attach inputs and detach after function exit</span></span>
<span id="cb2-91"><a href="#cb2-91"></a>  <span class="kw">apollo_attach</span>(apollo_beta, apollo_inputs)</span>
<span id="cb2-92"><a href="#cb2-92"></a>  <span class="kw">on.exit</span>(<span class="kw">apollo_detach</span>(apollo_beta, apollo_inputs))</span>
<span id="cb2-93"><a href="#cb2-93"></a>  </span>
<span id="cb2-94"><a href="#cb2-94"></a>  <span class="co">### Create list of probabilities P</span></span>
<span id="cb2-95"><a href="#cb2-95"></a>  P =<span class="st"> </span><span class="kw">list</span>()</span>
<span id="cb2-96"><a href="#cb2-96"></a>  </span>
<span id="cb2-97"><a href="#cb2-97"></a>  <span class="co">### List of utilities: these must use the same names as</span></span>
<span id="cb2-98"><a href="#cb2-98"></a>  <span class="co">### in mnl_settings, order is irrelevant.</span></span>
<span id="cb2-99"><a href="#cb2-99"></a>  V =<span class="st"> </span><span class="kw">list</span>()</span>
<span id="cb2-100"><a href="#cb2-100"></a>  V[[<span class="st">&#39;car&#39;</span>]]  =<span class="st"> </span>asc_car  <span class="op">+</span><span class="st"> </span>b_tt<span class="op">*</span>time_car  <span class="op">+</span><span class="st"> </span>b_c<span class="op">*</span>cost_car</span>
<span id="cb2-101"><a href="#cb2-101"></a>  V[[<span class="st">&#39;bus&#39;</span>]]  =<span class="st"> </span>asc_bus  <span class="op">+</span><span class="st"> </span>b_tt<span class="op">*</span>time_bus  <span class="op">+</span><span class="st"> </span>b_c<span class="op">*</span>cost_bus </span>
<span id="cb2-102"><a href="#cb2-102"></a>  V[[<span class="st">&#39;air&#39;</span>]]  =<span class="st"> </span>asc_air  <span class="op">+</span><span class="st"> </span>b_tt<span class="op">*</span>time_air  <span class="op">+</span><span class="st"> </span>b_c<span class="op">*</span>cost_air   </span>
<span id="cb2-103"><a href="#cb2-103"></a>  V[[<span class="st">&#39;rail&#39;</span>]] =<span class="st"> </span>asc_rail <span class="op">+</span><span class="st"> </span>b_tt<span class="op">*</span>time_rail <span class="op">+</span><span class="st"> </span>b_c<span class="op">*</span>cost_rail  </span>
<span id="cb2-104"><a href="#cb2-104"></a>  </span>
<span id="cb2-105"><a href="#cb2-105"></a>  <span class="co">### Define settings for MNL model component</span></span>
<span id="cb2-106"><a href="#cb2-106"></a>  mnl_settings =<span class="st"> </span><span class="kw">list</span>(</span>
<span id="cb2-107"><a href="#cb2-107"></a>    <span class="dt">alternatives  =</span> <span class="kw">c</span>(<span class="dt">car=</span><span class="dv">1</span>, <span class="dt">bus=</span><span class="dv">2</span>, <span class="dt">air=</span><span class="dv">3</span>, <span class="dt">rail=</span><span class="dv">4</span>), </span>
<span id="cb2-108"><a href="#cb2-108"></a>    <span class="dt">avail         =</span> <span class="kw">list</span>(<span class="dt">car=</span>av_car, <span class="dt">bus=</span>av_bus, </span>
<span id="cb2-109"><a href="#cb2-109"></a>                         <span class="dt">air=</span>av_air, <span class="dt">rail=</span>av_rail), </span>
<span id="cb2-110"><a href="#cb2-110"></a>    <span class="dt">choiceVar     =</span> choice,</span>
<span id="cb2-111"><a href="#cb2-111"></a>    <span class="dt">V             =</span> V</span>
<span id="cb2-112"><a href="#cb2-112"></a>  )</span>
<span id="cb2-113"><a href="#cb2-113"></a>  </span>
<span id="cb2-114"><a href="#cb2-114"></a>  <span class="co">### Compute probabilities using MNL model</span></span>
<span id="cb2-115"><a href="#cb2-115"></a>  P[[<span class="st">&#39;model&#39;</span>]] =<span class="st"> </span><span class="kw">apollo_mnl</span>(mnl_settings, functionality)</span>
<span id="cb2-116"><a href="#cb2-116"></a>  </span>
<span id="cb2-117"><a href="#cb2-117"></a>  <span class="co">### Take product across observation for same individual</span></span>
<span id="cb2-118"><a href="#cb2-118"></a>  P =<span class="st"> </span><span class="kw">apollo_panelProd</span>(P, apollo_inputs, functionality)</span>
<span id="cb2-119"><a href="#cb2-119"></a>  </span>
<span id="cb2-120"><a href="#cb2-120"></a>  <span class="co">### Average draws</span></span>
<span id="cb2-121"><a href="#cb2-121"></a>  P =<span class="st"> </span><span class="kw">apollo_avgInterDraws</span>(P, apollo_inputs, functionality)</span>
<span id="cb2-122"><a href="#cb2-122"></a>  </span>
<span id="cb2-123"><a href="#cb2-123"></a>  <span class="co">### Prepare and return outputs of function</span></span>
<span id="cb2-124"><a href="#cb2-124"></a>  P =<span class="st"> </span><span class="kw">apollo_prepareProb</span>(P, apollo_inputs, functionality)</span>
<span id="cb2-125"><a href="#cb2-125"></a>  <span class="kw">return</span>(P)</span>
<span id="cb2-126"><a href="#cb2-126"></a>}</span>
<span id="cb2-127"><a href="#cb2-127"></a></span>
<span id="cb2-128"><a href="#cb2-128"></a><span class="co"># ####################################################### #</span></span>
<span id="cb2-129"><a href="#cb2-129"></a><span class="co">#### 6. Model estimation and reporting                 ####</span></span>
<span id="cb2-130"><a href="#cb2-130"></a><span class="co"># ####################################################### #</span></span>
<span id="cb2-131"><a href="#cb2-131"></a></span>
<span id="cb2-132"><a href="#cb2-132"></a>model =<span class="st"> </span><span class="kw">apollo_estimate</span>(apollo_beta, apollo_fixed, </span>
<span id="cb2-133"><a href="#cb2-133"></a>                        apollo_probabilities, </span>
<span id="cb2-134"><a href="#cb2-134"></a>                        apollo_inputs)</span>
<span id="cb2-135"><a href="#cb2-135"></a></span>
<span id="cb2-136"><a href="#cb2-136"></a><span class="kw">apollo_modelOutput</span>(model)</span>
<span id="cb2-137"><a href="#cb2-137"></a></span>
<span id="cb2-138"><a href="#cb2-138"></a><span class="co">#apollo_saveOutput(model)</span></span>
<span id="cb2-139"><a href="#cb2-139"></a></span>
<span id="cb2-140"><a href="#cb2-140"></a><span class="co"># ####################################################### #</span></span>
<span id="cb2-141"><a href="#cb2-141"></a><span class="co">#### 7. Postprocessing of results                      ####</span></span>
<span id="cb2-142"><a href="#cb2-142"></a><span class="co"># ####################################################### #</span></span>
<span id="cb2-143"><a href="#cb2-143"></a></span>
<span id="cb2-144"><a href="#cb2-144"></a><span class="co">### Use the estimated model to make predictions</span></span>
<span id="cb2-145"><a href="#cb2-145"></a>predictions_base =<span class="st"> </span><span class="kw">apollo_prediction</span>(model, </span>
<span id="cb2-146"><a href="#cb2-146"></a>                                     apollo_probabilities, </span>
<span id="cb2-147"><a href="#cb2-147"></a>                                     apollo_inputs)</span>
<span id="cb2-148"><a href="#cb2-148"></a></span>
<span id="cb2-149"><a href="#cb2-149"></a><span class="co">### Now imagine the cost for rail increases by 10% </span></span>
<span id="cb2-150"><a href="#cb2-150"></a><span class="co">### and predict again</span></span>
<span id="cb2-151"><a href="#cb2-151"></a>database<span class="op">$</span>cost_rail =<span class="st"> </span><span class="fl">1.1</span><span class="op">*</span>database<span class="op">$</span>cost_rail</span>
<span id="cb2-152"><a href="#cb2-152"></a>apollo_inputs   =<span class="st"> </span><span class="kw">apollo_validateInputs</span>()</span>
<span id="cb2-153"><a href="#cb2-153"></a>predictions_new =<span class="st"> </span><span class="kw">apollo_prediction</span>(model, </span>
<span id="cb2-154"><a href="#cb2-154"></a>                                    apollo_probabilities, </span>
<span id="cb2-155"><a href="#cb2-155"></a>                                    apollo_inputs)</span>
<span id="cb2-156"><a href="#cb2-156"></a></span>
<span id="cb2-157"><a href="#cb2-157"></a><span class="co">### Compare predictions</span></span>
<span id="cb2-158"><a href="#cb2-158"></a>change=(predictions_new<span class="op">-</span>predictions_base)<span class="op">/</span>predictions_base</span>
<span id="cb2-159"><a href="#cb2-159"></a><span class="co">### Not interested in chosen alternative now, </span></span>
<span id="cb2-160"><a href="#cb2-160"></a><span class="co">### so drop last column</span></span>
<span id="cb2-161"><a href="#cb2-161"></a>change=change[,<span class="op">-</span><span class="kw">ncol</span>(change)]</span>
<span id="cb2-162"><a href="#cb2-162"></a><span class="co">### Summary of changes (possible presence of NAs due to</span></span>
<span id="cb2-163"><a href="#cb2-163"></a><span class="co">### unavailable alternatives)</span></span>
<span id="cb2-164"><a href="#cb2-164"></a><span class="kw">summary</span>(change)</span></code></pre></div>
</div>
<div id="references" class="section level2">
<h2>References</h2>
<ul>
<li>Ben-Akiva, M. and Lerman, S. (1985) <em>Discrete Choice Analysis</em>. Cambridge, Massachusetts. The MIT Press. ISBN 978-0-262-02217-0</li>
<li>Ben-Akiva, M.; McFadden, D.; Train, K.; Walker, J.; Bhat, C.; Bierlaire, M.; Bolduc, D.; Boersch-Supan, A.; Brownstone, D.; Bunch, D.; Daly, A.; De Palma, A.; Gopinath, D.; Karlstrom, A.; Munizaga, M. (2002) Hybrid Choice Models: Progress and Challenges. <em>Marketing Letters</em> <strong>13</strong>, 163 - 175.</li>
<li>Bhat, C. (2008) The multiple discrete-continuous extreme value (MDCEV) model: Role of utility function parameters, identification considerations,and model extensions. <em>Transportation Research</em> <strong>42B</strong>, 274 - 303.</li>
<li>Hancock, T.; Hess, S. and Choudhury, C. (2018) Decision field theory: Improvements to current methodology and comparisons with standard choice modelling techniques. <em>Transportation Research</em> <strong>107B</strong>, 18-40.</li>
<li>Pinjari, A. and Bhat, C. (2010) A multiple discrete–continuous nested extreme value (MDCNEV) model: Formulation and application to non-worker activity time-use and timing behavior on weekdays. <em>Transportation Research</em> <strong>44B</strong>, 562 - 583.</li>
<li>Train, K. (2009) <em>Discrete Choice Methods with Simulation</em>, 2nd edition. New York, New York. Cambridge University Press. ISBN 978-0-521-76655-5</li>
</ul>
</div>



<!-- code folding -->


<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
